<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap" rel="stylesheet">
<title>LCARS OS ‚Äî Voyager Edition</title>
<style>
  :root {
    --lcars-orange: #d06b12;
    --lcars-peach: #e89050;
    --lcars-gold: #b88910;
    --lcars-blue: #2f78ff;
    --lcars-lightblue: #cfe8ff;
    --lcars-teal: #7bd7c6;
    --lcars-cyan: #69e3ff;
    --lcars-purple: #8a6dff;
    --lcars-lavender: #a0a0ff;
    --lcars-pink: #cc6699;
    --lcars-red: #cc4444;
    --lcars-magenta: #cc66cc;
    --lcars-bg: #05070a;
    --lcars-text: #cfe8ff;
    --lcars-sidebar-w: 170px;
    --lcars-header-h: 80px;
    --lcars-footer-h: 48px;
    --lcars-radius: 30px;
    --lcars-font: 'Antonio', 'Helvetica Neue', Arial, sans-serif;
    --lcars-panel: #0b0f14;
    --lcars-glow: 0 0 0 1px rgba(255,255,255,.08), 0 18px 40px rgba(0,0,0,.45);
    --lcars-line: rgba(255,255,255,.09);
    --lcars-muted: rgba(207,232,255,.65);
    --lcars-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:radial-gradient(1200px 600px at 55% 35%,rgba(47,120,255,.12),transparent 55%),radial-gradient(900px 500px at 20% 55%,rgba(208,107,18,.08),transparent 55%),var(--lcars-bg); color:var(--lcars-text); font-family:var(--lcars-font); overflow:hidden; height:100vh; width:100vw; cursor:default; user-select:none; }
  .lcars-frame { display:grid; grid-template-columns:var(--lcars-sidebar-w) 1fr; grid-template-rows:var(--lcars-header-h) 1fr var(--lcars-footer-h); height:100vh; width:100vw; gap:4px; padding:6px; }
  .lcars-sidebar { grid-row:1/4; display:flex; flex-direction:column; gap:4px; }
  .sidebar-top { background:linear-gradient(180deg,var(--lcars-blue),rgba(47,120,255,.7)); height:100px; border-radius:var(--lcars-radius) 0 var(--lcars-radius) 0; display:flex; align-items:flex-end; justify-content:flex-end; padding:10px 14px; font-size:13px; color:rgba(255,255,255,.9); font-weight:700; letter-spacing:2px; box-shadow:var(--lcars-glow); }
  .sidebar-buttons { display:flex; flex-direction:column; gap:4px; flex:1; padding:2px 0; }
  .sidebar-btn { padding:8px 12px; font-family:var(--lcars-font); font-size:15px; font-weight:700; letter-spacing:1px; text-transform:uppercase; text-align:right; border:none; cursor:pointer; color:rgba(0,0,0,.85); transition:all 0.2s ease; min-height:38px; display:flex; align-items:center; justify-content:flex-end; border-radius:0 999px 999px 0; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset; }
  .sidebar-btn:hover { filter:brightness(1.25); transform:translateX(3px); }
  .sidebar-btn:active { filter:brightness(0.85); }
  .sidebar-btn.active { filter:brightness(1.3); box-shadow:0 0 0 1px rgba(0,0,0,.25) inset, 0 0 12px rgba(255,255,255,.15); }
  .sidebar-top, .header-bar { -webkit-app-region: drag; }
  .sidebar-btn, .header-segment { -webkit-app-region: no-drag; }
  .sidebar-bottom { background:linear-gradient(180deg,rgba(138,109,255,.7),var(--lcars-purple)); height:70px; border-radius:0 var(--lcars-radius) 0 var(--lcars-radius); display:flex; align-items:flex-start; justify-content:flex-end; padding:10px 14px; font-size:11px; color:rgba(255,255,255,.85); font-weight:700; letter-spacing:2px; box-shadow:var(--lcars-glow); }
  .lcars-header { display:flex; align-items:stretch; gap:4px; }
  .header-elbow { background:linear-gradient(135deg,var(--lcars-gold),rgba(184,137,16,.7)); width:140px; border-radius:0 0 0 var(--lcars-radius); position:relative; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset; }
  .header-elbow::after { content:''; position:absolute; bottom:0; right:-24px; width:24px; height:100%; background:transparent; border-radius:0 var(--lcars-radius) 0 0; }
  .header-bar { flex:1; display:flex; align-items:stretch; gap:4px; }
  .header-segment { flex:1; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; letter-spacing:2px; color:rgba(0,0,0,.85); text-transform:uppercase; border-radius:999px; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset; font-family:var(--lcars-mono); }
  .header-title { flex:3; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; letter-spacing:6px; color:var(--lcars-lightblue); text-transform:uppercase; background:transparent; text-shadow:0 0 20px rgba(207,232,255,.25); }
  .lcars-content { background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)); border:1px solid var(--lcars-line); border-radius:var(--lcars-radius); overflow:hidden; position:relative; box-shadow:var(--lcars-glow); }
  .lcars-footer { display:flex; align-items:stretch; gap:4px; }
  .footer-elbow { background:linear-gradient(135deg,rgba(138,109,255,.7),var(--lcars-purple)); width:140px; border-radius:var(--lcars-radius) 0 0 0; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset; }
  .footer-bar { flex:1; display:flex; align-items:stretch; gap:4px; }
  .footer-segment { flex:1; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; letter-spacing:1px; color:rgba(0,0,0,.85); border-radius:999px; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset; font-family:var(--lcars-mono); }
  .footer-status { flex:4; display:flex; align-items:center; padding:0 20px; font-size:13px; letter-spacing:2px; color:var(--lcars-teal); background:transparent; font-family:var(--lcars-mono); }
  .panel-container { width:100%; height:100%; display:none; padding:16px; overflow-y:auto; }
  .panel-container.active { display:block; }
  .panel-grid { display:grid; gap:14px; }
  .panel { background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01)); border:1px solid var(--lcars-line); border-radius:22px; padding:16px; position:relative; overflow:hidden; box-shadow:var(--lcars-glow); }
  .panel::before { content:''; position:absolute; top:0; left:0; width:5px; height:100%; border-radius:22px 0 0 22px; }
  .panel::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,rgba(255,255,255,.06),transparent 40%),linear-gradient(180deg,rgba(255,255,255,.04),transparent 55%); opacity:.5; pointer-events:none; border-radius:22px; }
  .panel-header { font-size:12px; font-weight:700; letter-spacing:2px; text-transform:uppercase; margin-bottom:12px; padding-left:12px; font-family:var(--lcars-mono); }
  .panel-body { padding-left:12px; position:relative; z-index:1; }
  .panel.blue::before { background:var(--lcars-blue); } .panel.blue .panel-header { color:rgba(47,120,255,.9); }
  .panel.teal::before { background:var(--lcars-teal); } .panel.teal .panel-header { color:var(--lcars-teal); }
  .panel.orange::before { background:var(--lcars-orange); } .panel.orange .panel-header { color:var(--lcars-orange); }
  .panel.purple::before { background:var(--lcars-purple); } .panel.purple .panel-header { color:var(--lcars-purple); }
  .panel.gold::before { background:var(--lcars-gold); } .panel.gold .panel-header { color:rgba(184,137,16,.95); }
  .panel.pink::before { background:var(--lcars-pink); } .panel.pink .panel-header { color:var(--lcars-pink); }
  .status-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; }
  .status-item { display:flex; flex-direction:column; gap:4px; }
  .status-label { font-size:11px; letter-spacing:2px; color:var(--lcars-muted); text-transform:uppercase; font-family:var(--lcars-mono); }
  .status-value { font-size:28px; font-weight:700; color:var(--lcars-lightblue); line-height:1; }
  .status-bar-track { height:10px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; margin-top:4px; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .status-bar-fill { height:100%; border-radius:999px; transition:width 1s ease; opacity:.9; }
  .graph-canvas { width:100%; height:120px; display:block; }
  .sensor-canvas { width:240px; height:240px; }
  .calc-display { background:rgba(0,0,0,0.5); border:1px solid var(--lcars-line); border-radius:12px; padding:12px 16px; text-align:right; font-size:32px; font-weight:700; color:var(--lcars-lightblue); margin-bottom:12px; min-height:54px; overflow:hidden; font-family:var(--lcars-mono); letter-spacing:2px; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .calc-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; }
  .calc-btn { padding:14px 8px; font-family:var(--lcars-font); font-size:18px; font-weight:700; border:none; border-radius:12px; cursor:pointer; color:rgba(0,0,0,.85); transition:all 0.15s; letter-spacing:1px; box-shadow:0 0 0 1px rgba(0,0,0,.2) inset; }
  .calc-btn:hover { filter:brightness(1.25); transform:scale(1.03); } .calc-btn:active { filter:brightness(0.7); transform:scale(0.97); }
  .calc-btn.num { background:var(--lcars-blue); } .calc-btn.op { background:var(--lcars-orange); }
  .calc-btn.fn { background:var(--lcars-teal); } .calc-btn.eq { background:var(--lcars-gold); }
  .calc-btn.clear { background:var(--lcars-red); color:#fff; }
  .file-path-bar { display:flex; align-items:center; gap:6px; padding:8px 12px; background:rgba(12,26,37,.85); border:1px solid var(--lcars-line); border-radius:999px; margin-bottom:12px; font-size:13px; color:var(--lcars-lightblue); letter-spacing:1px; font-family:var(--lcars-mono); box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .file-list { display:flex; flex-direction:column; gap:3px; }
  .file-item { display:flex; align-items:center; gap:12px; padding:10px 14px; background:rgba(255,255,255,.03); border-radius:12px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; }
  .file-item:hover { background:rgba(47,120,255,.1); border-color:var(--lcars-line); }
  .file-icon { font-size:20px; width:28px; text-align:center; }
  .file-name { flex:1; font-size:14px; color:var(--lcars-lightblue); letter-spacing:.5px; }
  .file-size { font-size:11px; color:var(--lcars-muted); letter-spacing:1px; font-family:var(--lcars-mono); }
  .file-date { font-size:11px; color:var(--lcars-teal); letter-spacing:1px; font-family:var(--lcars-mono); }
  .weather-main { display:flex; align-items:center; gap:20px; margin-bottom:16px; }
  .weather-temp { font-size:56px; font-weight:700; color:var(--lcars-lightblue); line-height:1; }
  .weather-desc { font-size:16px; color:var(--lcars-teal); letter-spacing:2px; text-transform:uppercase; }
  .weather-details { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  .weather-detail-item { text-align:center; }
  .weather-detail-label { font-size:11px; color:var(--lcars-muted); letter-spacing:1px; text-transform:uppercase; font-family:var(--lcars-mono); }
  .weather-detail-value { font-size:22px; font-weight:700; color:var(--lcars-lightblue); }
  .clock-main { text-align:center; padding:20px; }
  .clock-time { font-size:72px; font-weight:700; color:var(--lcars-lightblue); letter-spacing:4px; line-height:1; margin-bottom:8px; }
  .clock-date { font-size:20px; color:var(--lcars-teal); letter-spacing:3px; margin-bottom:4px; }
  .clock-stardate { font-size:24px; color:var(--lcars-orange); letter-spacing:3px; }
  .clock-analog { width:200px; height:200px; margin:20px auto; }
  .task-item { display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(255,255,255,.03); border:1px solid transparent; border-radius:12px; margin-bottom:4px; transition:all .15s; }
  .task-item:hover { border-color:var(--lcars-line); }
  .task-item.completed .task-text { text-decoration:line-through; opacity:0.4; }
  .task-item.completed .task-due { opacity:0.4; }
  .task-item.overdue .task-due { color:var(--lcars-red); }
  .task-check { width:20px; height:20px; border:2px solid var(--lcars-teal); border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .15s; }
  .task-check.done { background:var(--lcars-teal); }
  .task-text { flex:1; font-size:15px; color:var(--lcars-lightblue); letter-spacing:1px; }
  .task-priority { font-size:11px; letter-spacing:1px; padding:2px 8px; border-radius:4px; font-weight:700; }
  .task-priority.high { background:var(--lcars-red); color:#fff; }
  .task-priority.medium { background:var(--lcars-orange); color:#000; }
  .task-priority.low { background:var(--lcars-teal); color:#000; }
  .task-due { font-size:11px; letter-spacing:1px; color:var(--lcars-gold); white-space:nowrap; }
  .task-delete { color:var(--lcars-red); cursor:pointer; font-size:16px; padding:0 4px; }
  .task-delete:hover { filter:brightness(1.5); }
  .task-input-row { display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap; }
  .task-input { flex:1; min-width:200px; background:rgba(12,26,37,.85); border:1px solid var(--lcars-line); border-radius:999px; padding:10px 16px; color:var(--lcars-lightblue); font-family:var(--lcars-font); font-size:14px; letter-spacing:.5px; outline:none; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .task-input:focus { border-color:rgba(47,120,255,.4); }
  .task-input::placeholder { color:rgba(207,232,255,.3); }
  .task-select { background:rgba(12,26,37,.85); border:1px solid var(--lcars-line); border-radius:999px; padding:10px 12px; color:var(--lcars-lightblue); font-family:var(--lcars-font); font-size:13px; outline:none; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .task-date-input { background:rgba(12,26,37,.85); border:1px solid var(--lcars-line); border-radius:999px; padding:10px 12px; color:var(--lcars-lightblue); font-family:var(--lcars-font); font-size:13px; outline:none; color-scheme:dark; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .task-add-btn { padding:10px 20px; font-family:var(--lcars-font); font-size:14px; font-weight:700; letter-spacing:1px; border:none; border-radius:999px; cursor:pointer; color:rgba(0,0,0,.85); background:var(--lcars-teal); text-transform:uppercase; box-shadow:0 0 0 1px rgba(0,0,0,.2) inset; transition:all .15s; }
  .task-add-btn:hover { filter:brightness(1.2); transform:scale(1.03); }
  .task-filters { display:flex; gap:6px; margin-bottom:12px; }
  .task-filter-btn { padding:6px 14px; font-family:var(--lcars-font); font-size:12px; font-weight:700; letter-spacing:1px; border:none; border-radius:999px; cursor:pointer; color:rgba(0,0,0,.85); background:var(--lcars-blue); text-transform:uppercase; opacity:0.5; box-shadow:0 0 0 1px rgba(0,0,0,.2) inset; transition:all .15s; }
  .task-filter-btn.active { opacity:1; }
  .task-filter-btn:hover { filter:brightness(1.2); opacity:.85; }
  .task-stats { font-size:12px; color:var(--lcars-gold); letter-spacing:1px; margin-top:8px; }
  .city-search-input { flex:1; background:rgba(12,26,37,.85); border:1px solid var(--lcars-line); border-radius:999px; padding:10px 16px; color:var(--lcars-lightblue); font-family:var(--lcars-font); font-size:14px; letter-spacing:.5px; outline:none; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .city-search-input:focus { border-color:rgba(47,120,255,.4); }
  .city-search-input::placeholder { color:rgba(207,232,255,.3); }
  .city-result { padding:10px 14px; background:rgba(255,255,255,.03); border-radius:12px; cursor:pointer; margin-bottom:4px; color:var(--lcars-lightblue); font-size:13px; letter-spacing:.5px; transition:all .15s; border:1px solid transparent; }
  .city-result:hover { background:rgba(47,120,255,.1); border-color:var(--lcars-line); }
  ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); border-radius:3px; } ::-webkit-scrollbar-thumb { background:rgba(47,120,255,.4); border-radius:3px; } ::-webkit-scrollbar-thumb:hover { background:rgba(47,120,255,.6); }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
  @keyframes scanline { 0%{transform:translateY(-100%);} 100%{transform:translateY(100vh);} }
  .scanline-overlay { position:fixed; top:0; left:0; width:100%; height:2px; background:linear-gradient(transparent,rgba(105,227,255,0.03),transparent); animation:scanline 10s linear infinite; pointer-events:none; z-index:1000; }
  .pulse { animation:pulse 2s ease-in-out infinite; }
  /* Boot screen */
  .boot-screen { position:fixed; top:0; left:0; width:100vw; height:100vh; background:radial-gradient(800px 400px at 50% 40%,rgba(47,120,255,.08),transparent 55%),var(--lcars-bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; transition:opacity 1s ease; }
  .boot-screen.hidden { opacity:0; pointer-events:none; }
  .boot-text { font-family:var(--lcars-mono); font-size:14px; color:var(--lcars-teal); letter-spacing:2px; text-transform:uppercase; opacity:0; transition:opacity 0.3s; margin:4px 0; }
  .boot-text.visible { opacity:1; }
  .boot-title { font-size:42px; color:var(--lcars-lightblue); letter-spacing:12px; margin-bottom:40px; opacity:0; transition:opacity 1s ease, text-shadow 1s ease; font-family:var(--lcars-font); }
  .boot-title.visible { opacity:1; text-shadow:0 0 40px rgba(47,120,255,0.5), 0 0 80px rgba(47,120,255,0.2); }
  .boot-progress { width:400px; height:4px; background:rgba(255,255,255,.06); border-radius:999px; margin-top:30px; overflow:hidden; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
  .boot-progress-fill { height:100%; background:linear-gradient(90deg,var(--lcars-blue),var(--lcars-cyan)); border-radius:999px; width:0%; transition:width 0.4s ease; }
  /* Frame assembly animations */
  @keyframes slideInLeft { from{transform:translateX(-100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
  @keyframes slideInTop { from{transform:translateY(-100%);opacity:0;} to{transform:translateY(0);opacity:1;} }
  @keyframes slideInBottom { from{transform:translateY(100%);opacity:0;} to{transform:translateY(0);opacity:1;} }
  @keyframes fadeInScale { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
  @keyframes bootSweep { from{background-position:200% 0;} to{background-position:-200% 0;} }
  .boot-hidden { opacity:0 !important; visibility:hidden; }
  .lcars-sidebar.boot-animate { animation:slideInLeft 0.6s ease-out forwards; }
  .lcars-header.boot-animate { animation:slideInTop 0.5s ease-out forwards; }
  .lcars-footer.boot-animate { animation:slideInBottom 0.5s ease-out forwards; }
  .lcars-content.boot-animate { animation:fadeInScale 0.7s ease-out forwards; }
  .sidebar-btn.boot-dim { opacity:0.15; transition:opacity 0.15s ease; }
  .sidebar-btn.boot-lit { opacity:1; transition:opacity 0.15s ease; }
  .header-segment.boot-dim { opacity:0; transition:opacity 0.2s ease; }
  .header-segment.boot-lit { opacity:1; transition:opacity 0.2s ease; }
  .footer-segment.boot-dim { opacity:0; transition:opacity 0.2s ease; }
  .footer-segment.boot-lit { opacity:1; transition:opacity 0.2s ease; }
  .alert-bar { position:fixed; top:0; left:0; right:0; padding:10px 20px; text-align:center; font-size:13px; font-weight:700; letter-spacing:3px; text-transform:uppercase; z-index:500; transform:translateY(-100%); transition:transform 0.4s ease; font-family:var(--lcars-mono); border-radius:0 0 16px 16px; }
  .alert-bar.show { transform:translateY(0); }
  .panel.magenta { background:linear-gradient(180deg,rgba(204,102,204,.08),rgba(204,102,204,.02)); border:1px solid rgba(204,102,204,.2); }
  .starmap-info { box-shadow:0 0 15px rgba(204,102,204,0.3); }
  .starmap-info::-webkit-scrollbar { width:6px; }
  .starmap-info::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); border-radius:3px; }
  .starmap-info::-webkit-scrollbar-thumb { background:var(--lcars-magenta); border-radius:3px; }
  .alert-bar.red { background:var(--lcars-red); color:#fff; }
  .alert-bar.yellow { background:var(--lcars-orange); color:#000; }
  .alert-bar.blue { background:var(--lcars-blue); color:#000; }
  .starfield-canvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; opacity:0.2; }
  .comms-grid-item { display:flex; align-items:center; gap:10px; padding:8px 0; }
  .comms-icon { font-size:20px; width:28px; text-align:center; }
  .comms-label { font-size:11px; letter-spacing:1.5px; color:var(--lcars-muted); text-transform:uppercase; font-family:var(--lcars-mono); }
  .comms-value { font-size:15px; font-weight:700; color:var(--lcars-lightblue); }
  .app-launcher { display:inline-flex; flex-direction:column; align-items:center; gap:6px; padding:12px; cursor:pointer; border-radius:14px; transition:all 0.15s; width:80px; text-align:center; border:1px solid transparent; }
  .app-launcher:hover { background:rgba(47,120,255,.1); border-color:var(--lcars-line); }
  .app-launcher-icon { font-size:28px; }
  .app-launcher-name { font-size:11px; color:var(--lcars-muted); letter-spacing:.5px; }
</style>
</head>
<body>
<canvas class="starfield-canvas" id="starfield"></canvas>
<div class="scanline-overlay"></div>
<div class="alert-bar" id="alertBar"></div>

<div class="boot-screen" id="bootScreen">
  <div class="boot-text boot-title" id="bootTitle">LCARS OS</div>
  <div class="boot-text" id="boot1">Initializing Voyager Operating System...</div>
  <div class="boot-text" id="boot2">Loading Bio-Neural Gel Pack Interface...</div>
  <div class="boot-text" id="boot3">Establishing Quantum Core Link...</div>
  <div class="boot-text" id="boot4">Calibrating Sensor Arrays...</div>
  <div class="boot-text" id="boot5">Loading LCARS Display Modules...</div>
  <div class="boot-text" id="boot6">System Ready ‚Äî Welcome Aboard</div>
  <div class="boot-progress"><div class="boot-progress-fill" id="bootProgress"></div></div>
</div>

<div class="lcars-frame" id="mainFrame" style="opacity:0;">
  <div class="lcars-sidebar">
    <div class="sidebar-top">LCARS 47.1.1</div>
    <div class="sidebar-buttons">
      <button class="sidebar-btn active" style="background:linear-gradient(90deg,var(--lcars-orange),rgba(208,107,18,.7));" onclick="switchPanel('ops')" id="btn-ops">Operations</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-teal),rgba(123,215,198,.7));" onclick="switchPanel('tactical')" id="btn-tactical">Tactical</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-blue),rgba(47,120,255,.7));" onclick="switchPanel('science')" id="btn-science">Science</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-gold),rgba(184,137,16,.7));" onclick="switchPanel('comms')" id="btn-comms">Comms</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-purple),rgba(138,109,255,.7));" onclick="switchPanel('computer')" id="btn-computer">Computer</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-peach),rgba(232,144,80,.7));" onclick="switchPanel('files')" id="btn-files">Database</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-pink),rgba(204,102,153,.7));" onclick="switchPanel('notepad')" id="btn-notepad">Log Entry</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-cyan),rgba(105,227,255,.7));" onclick="switchPanel('settings')" id="btn-settings">Config</button>
      <button class="sidebar-btn" style="background:linear-gradient(90deg,var(--lcars-magenta),rgba(204,102,204,.7));" onclick="switchPanel('starmap')" id="btn-starmap">Star Map</button>
    </div>
    <div class="sidebar-bottom">NCC-74656</div>
  </div>

  <div class="lcars-header">
    <div class="header-elbow"></div>
    <div class="header-bar">
      <div class="header-segment" style="background:var(--lcars-teal);" id="headerStardate">SD 79145.7</div>
      <div class="header-title" id="panelTitle">OPERATIONS</div>
      <div class="header-segment" style="background:var(--lcars-gold);" id="headerTime">00:00:00</div>
      <div class="header-segment" style="background:var(--lcars-orange);"><span id="headerStatus" class="pulse">‚óè ONLINE</span></div>
    </div>
  </div>

  <div class="lcars-content">
    <!-- OPS -->
    <div class="panel-container active" id="panel-ops">
      <div style="display:grid;grid-template-columns:160px 1fr 160px;gap:8px;height:100%;padding:6px;">

        <!-- LEFT: Metrics + Clock/Weather -->
        <div style="display:flex;flex-direction:column;gap:4px;overflow-y:auto;">
          <div style="color:var(--lcars-blue);font-weight:700;font-size:10px;letter-spacing:2px;padding:2px 0;font-family:var(--lcars-mono);">SYSTEMS</div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">CPU</span><span class="status-value" id="cpuValue" style="font-size:12px;">0%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="cpuBar" style="width:0%;background:var(--lcars-blue);"></div></div></div>
          <canvas class="graph-canvas" id="cpuGraph" style="height:30px;"></canvas>
          <div class="status-item"><span class="status-label" style="font-size:9px;">MEM</span><span class="status-value" id="memValue" style="font-size:12px;">0%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="memBar" style="width:0%;background:var(--lcars-teal);"></div></div></div>
          <canvas class="graph-canvas" id="memGraph" style="height:30px;"></canvas>
          <div class="status-item"><span class="status-label" style="font-size:9px;">DISK</span><span class="status-value" id="warpPower" style="font-size:12px;">‚Äî</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="warpBar" style="width:0%;background:var(--lcars-orange);"></div></div></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">BATT</span><span class="status-value" id="impulsePower" style="font-size:12px;">‚Äî</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="impulseBar" style="width:0%;background:var(--lcars-orange);"></div></div></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">THERM</span><span class="status-value" id="auxPower" style="font-size:12px;">‚Äî</span></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">NET</span><span class="status-value" id="netValue" style="font-size:12px;">0 Mb/s</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="netBar" style="width:0%;background:var(--lcars-purple);"></div></div></div>
          <canvas class="graph-canvas" id="netGraph" style="height:30px;"></canvas>
          <div class="status-item"><span class="status-label" style="font-size:9px;">UP</span><span class="status-value" id="dashUptime" style="font-size:12px;">‚Äî</span></div>
          <div style="border-top:1px solid var(--lcars-line);margin:4px 0;"></div>
          <div id="dashTime" style="color:var(--lcars-gold);font-size:16px;font-weight:700;letter-spacing:1px;font-family:var(--lcars-mono);">00:00:00</div>
          <div id="dashStardate" style="color:var(--lcars-teal);font-size:10px;letter-spacing:1px;font-family:var(--lcars-mono);">SD ‚Äî</div>
          <div style="margin-top:2px;"><span id="dashWeatherIcon" style="font-size:16px;">üå§</span> <span id="dashWeatherTemp" style="color:var(--lcars-orange);font-size:13px;font-weight:700;">‚Äî</span><div id="dashWeatherDesc" style="color:var(--lcars-muted);font-size:10px;">‚Äî</div></div>
        </div>

        <!-- CENTRE: Star Map -->
        <div style="position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--lcars-line);">
          <canvas id="opsStarMap" style="width:100%;height:100%;display:block;background:rgba(0,5,15,0.8);"></canvas>
          <div style="position:absolute;bottom:6px;left:8px;font-size:9px;color:var(--lcars-muted);font-family:var(--lcars-mono);letter-spacing:1px;pointer-events:none;">STELLAR CARTOGRAPHY</div>
        </div>

        <!-- RIGHT: Shields + Comms + Tasks -->
        <div style="display:flex;flex-direction:column;gap:4px;overflow-y:auto;">
          <div style="color:var(--lcars-blue);font-weight:700;font-size:10px;letter-spacing:2px;padding:2px 0;font-family:var(--lcars-mono);">SHIELDS</div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">FWD</span><span class="status-value" id="dashShieldFwd" style="font-size:11px;">100%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="dashShieldFwdBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">AFT</span><span class="status-value" id="dashShieldAft" style="font-size:11px;">100%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="dashShieldAftBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">PORT</span><span class="status-value" id="dashShieldPort" style="font-size:11px;">100%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="dashShieldPortBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
          <div class="status-item"><span class="status-label" style="font-size:9px;">STBD</span><span class="status-value" id="dashShieldStbd" style="font-size:11px;">100%</span><div class="status-bar-track" style="height:6px;"><div class="status-bar-fill" id="dashShieldStbdBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
          <div style="border-top:1px solid var(--lcars-line);margin:4px 0;"></div>
          <div style="color:var(--lcars-teal);font-weight:700;font-size:10px;letter-spacing:2px;padding:2px 0;font-family:var(--lcars-mono);">COMMS</div>
          <div style="font-size:10px;color:var(--lcars-lightblue);line-height:1.7;">
            <div>üì∂ <span id="dashWifi">Scanning...</span></div>
            <div>üîµ <span id="dashBluetooth">Scanning...</span></div>
            <div>üîä <span id="dashVolume">‚Äî</span></div>
            <div>üîÜ <span id="dashBrightness">‚Äî</span></div>
          </div>
          <div style="border-top:1px solid var(--lcars-line);margin:4px 0;"></div>
          <div style="color:var(--lcars-pink);font-weight:700;font-size:10px;letter-spacing:2px;padding:2px 0;font-family:var(--lcars-mono);">MISSION</div>
          <div id="dashTaskSummary" style="font-size:10px;color:var(--lcars-lightblue);line-height:1.5;">No tasks</div>
          <div id="dashLatestLog" style="font-size:9px;color:var(--lcars-lavender);margin-top:2px;font-style:italic;overflow:hidden;max-height:36px;"></div>
        </div>

      </div>
    </div>

    <!-- TACTICAL -->
    <div class="panel-container" id="panel-tactical">
      <div class="panel-grid" style="grid-template-columns:1fr 1fr;">
        <div class="panel blue" style="grid-column:1/-1;">
          <div class="panel-header">Shield Status</div>
          <div class="panel-body">
            <div class="status-grid" style="grid-template-columns:repeat(4,1fr);">
              <div class="status-item"><span class="status-label">Forward</span><span class="status-value" id="shieldFwd">100%</span><div class="status-bar-track"><div class="status-bar-fill" id="shieldFwdBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
              <div class="status-item"><span class="status-label">Aft</span><span class="status-value" id="shieldAft">100%</span><div class="status-bar-track"><div class="status-bar-fill" id="shieldAftBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
              <div class="status-item"><span class="status-label">Port</span><span class="status-value" id="shieldPort">100%</span><div class="status-bar-track"><div class="status-bar-fill" id="shieldPortBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
              <div class="status-item"><span class="status-label">Starboard</span><span class="status-value" id="shieldStbd">100%</span><div class="status-bar-track"><div class="status-bar-fill" id="shieldStbdBar" style="width:100%;background:var(--lcars-blue);"></div></div></div>
            </div>
          </div>
        </div>
        <div class="panel teal">
          <div class="panel-header">Sensor Sweep</div>
          <div class="panel-body" style="display:flex;justify-content:center;"><canvas class="sensor-canvas" id="sensorCanvas" width="240" height="240"></canvas></div>
        </div>
        <div class="panel orange">
          <div class="panel-header">Weapons Array</div>
          <div class="panel-body">
            <div class="status-grid" style="grid-template-columns:1fr;">
              <div class="status-item"><span class="status-label">Phaser Banks</span><span class="status-value" style="color:var(--lcars-teal);">CHARGED</span><div class="status-bar-track"><div class="status-bar-fill" style="width:100%;background:var(--lcars-teal);"></div></div></div>
              <div class="status-item"><span class="status-label">Photon Torpedoes</span><span class="status-value">38</span></div>
              <div class="status-item"><span class="status-label">Targeting Lock</span><span class="status-value" style="color:var(--lcars-gold);">STANDBY</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCIENCE -->
    <div class="panel-container" id="panel-science">
      <div class="panel-grid" style="grid-template-columns:1fr 1fr;">
        <div class="panel teal" style="grid-column:1/-1;">
          <div class="panel-header">Astrometrics</div>
          <div class="panel-body"><canvas id="astrometricsCanvas" width="800" height="250" style="width:100%;height:250px;border-radius:8px;"></canvas></div>
        </div>
        <div class="panel blue">
          <div class="panel-header">Stellar Cartography</div>
          <div class="panel-body">
            <div class="status-grid" style="grid-template-columns:1fr;">
              <div class="status-item"><span class="status-label">Current Sector</span><span class="status-value" style="font-size:20px;">Delta Quadrant ‚Äî Grid 986</span></div>
              <div class="status-item"><span class="status-label">Nearest Starbase</span><span class="status-value" style="font-size:18px;">67,421 Light Years</span></div>
              <div class="status-item"><span class="status-label">Subspace Anomalies</span><span class="status-value" style="font-size:18px;color:var(--lcars-gold);">3 Detected</span></div>
            </div>
          </div>
        </div>
        <div class="panel purple">
          <div class="panel-header">Environmental</div>
          <div class="panel-body">
            <div class="status-grid" style="grid-template-columns:1fr;">
              <div class="status-item"><span class="status-label">Atmosphere</span><span class="status-value" style="font-size:18px;color:var(--lcars-teal);">NOMINAL</span></div>
              <div class="status-item"><span class="status-label">Gravity</span><span class="status-value" style="font-size:18px;">1.0 G</span></div>
              <div class="status-item"><span class="status-label">Radiation</span><span class="status-value" style="font-size:18px;color:var(--lcars-teal);">0.02 mSv</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COMMS -->
    <div class="panel-container" id="panel-comms">
      <div class="panel-grid" style="grid-template-columns:1fr 1fr;">
        <div class="panel gold" style="grid-column:1/-1;">
          <div class="panel-header">Weather Station ‚Äî <span id="weatherCityLabel">Earth</span></div>
          <div class="panel-body">
            <div class="weather-main"><div style="font-size:48px;" id="weatherIcon">üå§</div><div><div class="weather-temp" id="weatherTemp">‚Äî</div><div class="weather-desc" id="weatherDesc">LOADING...</div></div></div>
            <div class="weather-details">
              <div class="weather-detail-item"><div class="weather-detail-label">Humidity</div><div class="weather-detail-value" id="weatherHumidity">‚Äî</div></div>
              <div class="weather-detail-item"><div class="weather-detail-label">Wind</div><div class="weather-detail-value" id="weatherWind">‚Äî</div></div>
              <div class="weather-detail-item"><div class="weather-detail-label">Pressure</div><div class="weather-detail-value" id="weatherPressure">‚Äî</div></div>
            </div>
          </div>
        </div>
        <div class="panel blue">
          <div class="panel-header">System Comms</div>
          <div class="panel-body">
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div class="comms-grid-item"><span class="comms-icon">üì∂</span><div><div class="comms-label">Wi-Fi Network</div><div class="comms-value" id="commsWifi">Scanning...</div></div></div>
              <div class="comms-grid-item"><span class="comms-icon">üîµ</span><div><div class="comms-label">Bluetooth</div><div class="comms-value" id="commsBluetooth">Scanning...</div></div></div>
              <div class="comms-grid-item"><span class="comms-icon">üîä</span><div><div class="comms-label">Volume</div><div class="comms-value" id="commsVolume">‚Äî</div></div></div>
              <div class="comms-grid-item"><span class="comms-icon">üîÜ</span><div><div class="comms-label">Brightness</div><div class="comms-value" id="commsBrightness">‚Äî</div></div></div>
            </div>
          </div>
        </div>
        <div class="panel teal">
          <div class="panel-header">Quick Launch</div>
          <div class="panel-body">
            <div style="display:flex;flex-wrap:wrap;gap:4px;">
              <div class="app-launcher" onclick="launchApp('Safari')"><span class="app-launcher-icon">üß≠</span><span class="app-launcher-name">Safari</span></div>
              <div class="app-launcher" onclick="launchApp('Mail')"><span class="app-launcher-icon">üìß</span><span class="app-launcher-name">Mail</span></div>
              <div class="app-launcher" onclick="launchApp('Messages')"><span class="app-launcher-icon">üí¨</span><span class="app-launcher-name">Messages</span></div>
              <div class="app-launcher" onclick="launchApp('Music')"><span class="app-launcher-icon">üéµ</span><span class="app-launcher-name">Music</span></div>
              <div class="app-launcher" onclick="launchApp('Terminal')"><span class="app-launcher-icon">üñ•Ô∏è</span><span class="app-launcher-name">Terminal</span></div>
              <div class="app-launcher" onclick="launchApp('Finder')"><span class="app-launcher-icon">üìÅ</span><span class="app-launcher-name">Finder</span></div>
            </div>
          </div>
        </div>
        <div class="panel orange" style="grid-column:1/-1;">
          <div class="panel-header">Chronometer</div>
          <div class="panel-body">
            <div class="clock-main">
              <div class="clock-time" id="clockTime">00:00:00</div>
              <div class="clock-date" id="clockDate">STARDATE 79145.7</div>
              <div class="clock-stardate" id="clockStardate"></div>
              <canvas class="clock-analog" id="clockCanvas" width="200" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COMPUTER -->
    <div class="panel-container" id="panel-computer">
      <div class="panel-grid" style="grid-template-columns:1fr 1fr;">
        <div class="panel blue">
          <div class="panel-header">Computational Interface</div>
          <div class="panel-body">
            <div class="calc-display" id="calcDisplay">0</div>
            <div class="calc-grid">
              <button class="calc-btn clear" onclick="calcClear()">C</button>
              <button class="calc-btn fn" onclick="calcInput('(')">(</button>
              <button class="calc-btn fn" onclick="calcInput(')')">)</button>
              <button class="calc-btn op" onclick="calcInput('/')">√∑</button>
              <button class="calc-btn num" onclick="calcInput('7')">7</button>
              <button class="calc-btn num" onclick="calcInput('8')">8</button>
              <button class="calc-btn num" onclick="calcInput('9')">9</button>
              <button class="calc-btn op" onclick="calcInput('*')">√ó</button>
              <button class="calc-btn num" onclick="calcInput('4')">4</button>
              <button class="calc-btn num" onclick="calcInput('5')">5</button>
              <button class="calc-btn num" onclick="calcInput('6')">6</button>
              <button class="calc-btn op" onclick="calcInput('-')">‚àí</button>
              <button class="calc-btn num" onclick="calcInput('1')">1</button>
              <button class="calc-btn num" onclick="calcInput('2')">2</button>
              <button class="calc-btn num" onclick="calcInput('3')">3</button>
              <button class="calc-btn op" onclick="calcInput('+')">+</button>
              <button class="calc-btn num" onclick="calcInput('0')" style="grid-column:span 2;">0</button>
              <button class="calc-btn num" onclick="calcInput('.')">.</button>
              <button class="calc-btn eq" onclick="calcEquals()">=</button>
            </div>
          </div>
        </div>
        <div class="panel teal">
          <div class="panel-header">System Directory</div>
          <div class="panel-body">
            <div class="status-grid" style="grid-template-columns:1fr;">
              <div class="status-item"><span class="status-label">OS Version</span><span class="status-value" style="font-size:16px;">LCARS 4.7.2 Voyager</span></div>
              <div class="status-item"><span class="status-label">Architecture</span><span class="status-value" style="font-size:16px;">Apple Silicon (ARM64)</span></div>
              <div class="status-item"><span class="status-label">Bio-Neural Gel Packs</span><span class="status-value" style="font-size:16px;color:var(--lcars-teal);">47 / 47 ONLINE</span></div>
              <div class="status-item"><span class="status-label">Uptime</span><span class="status-value" style="font-size:16px;" id="uptimeValue">0d 0h 0m</span></div>
              <div class="status-item"><span class="status-label">Holographic Subroutines</span><span class="status-value" style="font-size:16px;color:var(--lcars-gold);">EMH Mark I Active</span></div>
              <div class="status-item"><span class="status-label">Delta Quadrant ETA</span><span class="status-value" style="font-size:16px;">~70 Years</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- FILES / DATABASE -->
    <div class="panel-container" id="panel-files">
      <div class="panel-grid" style="grid-template-columns:1fr;">
        <div class="panel blue">
          <div class="panel-header">Ship's Database</div>
          <div class="panel-body">
            <div class="file-path-bar"><span style="color:var(--lcars-gold);cursor:pointer;" onclick="navigateUp()">‚óÜ</span><span id="filePath">~/</span></div>
            <div class="file-list" id="fileList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOG ENTRY / TASK LIST -->
    <div class="panel-container" id="panel-notepad">
      <div class="panel-grid" style="grid-template-columns:1fr;">
        <div class="panel pink">
          <div class="panel-header">Mission Tasks</div>
          <div class="panel-body">
            <div class="task-input-row">
              <input type="text" class="task-input" id="taskInput" placeholder="Enter new task..." onkeydown="if(event.key==='Enter')addTask()">
              <select class="task-select" id="taskPriority">
                <option value="medium">MEDIUM</option>
                <option value="high">HIGH</option>
                <option value="low">LOW</option>
              </select>
              <input type="date" class="task-date-input" id="taskDueDate" title="Due date (optional)">
              <button class="task-add-btn" onclick="addTask()">ADD</button>
            </div>
            <div class="task-filters">
              <button class="task-filter-btn active" onclick="setTaskFilter('all')" id="filterAll">ALL</button>
              <button class="task-filter-btn" onclick="setTaskFilter('active')" id="filterActive">ACTIVE</button>
              <button class="task-filter-btn" onclick="setTaskFilter('completed')" id="filterCompleted">DONE</button>
              <button class="task-filter-btn" onclick="setTaskFilter('overdue')" id="filterOverdue" style="background:var(--lcars-red);color:#fff;">OVERDUE</button>
              <button class="task-filter-btn" onclick="purgeCompleted()" style="background:var(--lcars-red);color:#fff;">PURGE</button>
            </div>
            <div id="taskList"></div>
            <div class="task-stats" id="taskStats"></div>
          </div>
        </div>
        <div class="panel purple" style="margin-top:10px;">
          <div class="panel-header">Captain's Log</div>
          <div class="panel-body">
            <textarea id="logEntry" style="width:100%;height:80px;background:rgba(0,10,25,0.8);color:var(--lcars-lightblue);border:1px solid var(--lcars-purple);border-radius:6px;padding:10px;font-family:inherit;font-size:13px;resize:vertical;" placeholder="Record your log entry..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button class="task-add-btn" style="background:var(--lcars-purple);" onclick="addLogEntry()">RECORD ENTRY</button>
              <button class="task-add-btn" style="background:var(--lcars-red);color:#fff;" onclick="clearAllLogs()">CLEAR ALL</button>
            </div>
            <div id="logEntries" style="margin-top:12px;max-height:300px;overflow-y:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS / CONFIG -->
    <div class="panel-container" id="panel-settings">
      <div class="panel-grid" style="grid-template-columns:1fr 1fr;">
        <div class="panel gold">
          <div class="panel-header">Alert Controls</div>
          <div class="panel-body">
            <div style="display:flex;flex-direction:column;gap:8px;">
              <button class="sidebar-btn" style="background:var(--lcars-red);border-radius:6px;justify-content:center;color:#fff;" onclick="triggerAlert('red')">RED ALERT</button>
              <button class="sidebar-btn" style="background:var(--lcars-orange);border-radius:6px;justify-content:center;" onclick="triggerAlert('yellow')">YELLOW ALERT</button>
              <button class="sidebar-btn" style="background:var(--lcars-blue);border-radius:6px;justify-content:center;" onclick="triggerAlert('blue')">BLUE ALERT</button>
              <button class="sidebar-btn" style="background:var(--lcars-teal);border-radius:6px;justify-content:center;" onclick="triggerAlert('clear')">CLEAR ALERT</button>
            </div>
          </div>
        </div>
        <div class="panel teal">
          <div class="panel-header">Audio Controls</div>
          <div class="panel-body">
            <div style="display:flex;flex-direction:column;gap:8px;">
              <button class="sidebar-btn" style="background:var(--lcars-teal);border-radius:6px;justify-content:center;" onclick="toggleSound()"><span id="soundToggle">ENABLE AUDIO</span></button>
              <button class="sidebar-btn" style="background:var(--lcars-lavender);border-radius:6px;justify-content:center;" onclick="playTestTone()">TEST COMM SIGNAL</button>
              <button class="sidebar-btn" style="background:var(--lcars-peach);border-radius:6px;justify-content:center;" onclick="playBoatswain()">BOATSWAIN WHISTLE</button>
            </div>
          </div>
        </div>
        <div class="panel purple" style="grid-column:1/-1;">
          <div class="panel-header">Display Configuration</div>
          <div class="panel-body">
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="sidebar-btn" style="background:var(--lcars-blue);border-radius:6px;padding:12px 24px;" onclick="setTheme('voyager')">VOYAGER</button>
              <button class="sidebar-btn" style="background:var(--lcars-orange);border-radius:6px;padding:12px 24px;" onclick="setTheme('tng')">TNG CLASSIC</button>
              <button class="sidebar-btn" style="background:var(--lcars-teal);border-radius:6px;padding:12px 24px;" onclick="setTheme('dark')">DARK MODE</button>
              <button class="sidebar-btn" style="background:var(--lcars-lightblue);border-radius:6px;padding:12px 24px;" onclick="setTheme('snw')">STRANGE NEW WORLDS</button>
            </div>
          </div>
        </div>
        <div class="panel blue" style="grid-column:1/-1;">
          <div class="panel-header">Weather Location</div>
          <div class="panel-body">
            <div style="margin-bottom:8px;font-size:12px;color:var(--lcars-gold);letter-spacing:1px;" id="currentLocationInfo">Current: Default (auto-detect)</div>
            <div style="display:flex;gap:6px;margin-bottom:12px;">
              <input type="text" class="city-search-input" id="citySearchInput" placeholder="Search city name..." onkeydown="if(event.key==='Enter')searchCity()">
              <button class="task-add-btn" onclick="searchCity()">SEARCH</button>
            </div>
            <div id="cityResults"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- STAR MAP -->
    <div class="panel-container" id="panel-starmap">
      <div class="panel-grid" style="grid-template-columns:1fr;">
        <div class="panel magenta" style="grid-column:1/-1;height:calc(100vh - 200px);padding:12px;position:relative;">
          <div class="panel-header" style="color:var(--lcars-magenta);">STELLAR CARTOGRAPHY</div>
          <div class="panel-body" style="padding:0;height:calc(100% - 40px);position:relative;">
            <canvas id="starMapCanvas" style="width:100%;height:100%;display:block;border-radius:6px;background:rgba(0,5,15,0.8);"></canvas>
            <div id="starMapInfo" class="starmap-info" style="display:none;position:absolute;top:20px;right:20px;background:rgba(0,10,25,0.95);border:2px solid var(--lcars-magenta);border-radius:8px;padding:16px;min-width:280px;z-index:100;font-size:13px;">
              <div style="color:var(--lcars-magenta);font-weight:700;letter-spacing:2px;margin-bottom:12px;">STELLAR DATA</div>
              <div id="starMapName" style="color:var(--lcars-lightblue);font-size:16px;font-weight:700;margin-bottom:8px;"></div>
              <div id="starMapDistance" style="color:var(--lcars-teal);margin-bottom:4px;"></div>
              <div id="starMapSpectral" style="color:var(--lcars-gold);margin-bottom:4px;"></div>
              <div id="starMapMagnitude" style="color:var(--lcars-peach);margin-bottom:8px;"></div>
              <div id="starMapConstellation" style="color:var(--lcars-pink);margin-bottom:12px;font-style:italic;"></div>
              <button class="sidebar-btn" style="background:var(--lcars-magenta);border-radius:4px;padding:6px 12px;font-size:12px;justify-content:center;width:100%;margin-top:8px;" onclick="closeStarInfo()">CLOSE</button>
            </div>
          </div>
          <div style="position:absolute;bottom:12px;left:20px;right:20px;font-size:11px;color:var(--lcars-gold);letter-spacing:1px;">
            <span id="starMapCoords" style="color:var(--lcars-lightblue);">Range: ¬±50.0 LY | Zoom: 1.0x</span> &nbsp;|&nbsp; Drag: Pan &nbsp;|&nbsp; Scroll: Zoom &nbsp;|&nbsp; Click: Select
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="lcars-footer">
    <div class="footer-elbow"></div>
    <div class="footer-bar">
      <div class="footer-segment" style="background:var(--lcars-teal);">47-ALPHA</div>
      <div class="footer-segment" style="background:var(--lcars-gold);">SEC LVL 4</div>
      <div class="footer-segment" style="background:var(--lcars-blue);" id="footerAlert">ALL CLEAR</div>
      <div class="footer-status" id="footerStatus">LCARS INTERFACE ACTIVE ‚Äî ALL SYSTEMS NOMINAL</div>
    </div>
  </div>
</div>

<script>
// ============================================
// LCARS OS ‚Äî Voyager Edition (Full Build)
// ============================================

var isTauri = (typeof window.__TAURI_INTERNALS__ !== 'undefined' && typeof window.__TAURI_INTERNALS__.invoke === 'function');
var lastRxBytes = 0, lastTxBytes = 0;
var audioEnabled = false, audioCtx = null;
var bootStartTime = Date.now();
var currentPanel = 'ops';
var calcExpression = '';
var sensorAngle = 0, blips = [];
var stars = [], bgStars = [];
var currentPath = '';
var alertTimeout = null;
var cpuHistory = new Array(60).fill(0);
var memHistory = new Array(60).fill(0);
var netHistory = new Array(60).fill(0);
var taskFilter = 'all';
var warpMode = false, warpSpeed = 0, lastActivity = Date.now(), WARP_IDLE_MS = 60000;
var tasks = [];
var weatherLat = null;
var weatherLon = null;
var weatherCityName = '';

var starMapData = [
  {name:'Sol',dist:0,spectral:'G2V',mag:4.83,x:0,y:0,constellation:'‚Äî',color:'#ffff00'},
  {name:'Proxima Centauri',dist:4.24,spectral:'M5.5V',mag:11.05,x:1.0,y:-4.1,constellation:'Centaurus',color:'#ff4444'},
  {name:'Alpha Centauri A',dist:4.37,spectral:'G2V',mag:0.01,x:1.1,y:-4.2,constellation:'Centaurus',color:'#ffff99'},
  {name:'Alpha Centauri B',dist:4.37,spectral:'K1V',mag:1.33,x:1.15,y:-4.15,constellation:'Centaurus',color:'#ffdd88'},
  {name:'Barnard\'s Star',dist:5.96,spectral:'M4V',mag:9.53,x:4.5,y:3.8,constellation:'Ophiuchus',color:'#ff5555'},
  {name:'Wolf 359',dist:7.78,spectral:'M6V',mag:13.54,x:-5.5,y:5.2,constellation:'Leo',color:'#ff3333'},
  {name:'Lalande 21185',dist:8.29,spectral:'M2V',mag:7.47,x:-1.2,y:8.0,constellation:'Ursa Major',color:'#ff6644'},
  {name:'Sirius A',dist:8.6,spectral:'A1V',mag:-1.46,x:7.8,y:3.2,constellation:'Canis Major',color:'#e6f3ff'},
  {name:'Sirius B',dist:8.6,spectral:'DA2',mag:8.44,x:7.85,y:3.25,constellation:'Canis Major',color:'#ffffff'},
  {name:'Luyten 726-8 A',dist:8.72,spectral:'M5.5V',mag:12.29,x:3.2,y:-7.8,constellation:'Cetus',color:'#ff4444'},
  {name:'Ross 154',dist:9.69,spectral:'M3.5V',mag:10.45,x:-8.5,y:-4.2,constellation:'Sagittarius',color:'#ff5544'},
  {name:'Ross 248',dist:10.32,spectral:'M5.5V',mag:12.29,x:9.2,y:4.5,constellation:'Andromeda',color:'#ff4444'},
  {name:'Epsilon Eridani',dist:10.5,spectral:'K2V',mag:3.73,x:-7.8,y:6.5,constellation:'Eridanus',color:'#ffdd88'},
  {name:'Lacaille 9352',dist:10.74,spectral:'M0.5V',mag:7.34,x:5.2,y:-9.0,constellation:'Piscis Austrinus',color:'#ff7744'},
  {name:'Ross 128',dist:10.94,spectral:'M4V',mag:11.13,x:-3.5,y:10.2,constellation:'Virgo',color:'#ff5555'},
  {name:'Procyon A',dist:11.46,spectral:'F5IV-V',mag:0.38,x:-11.2,y:2.8,constellation:'Canis Minor',color:'#ffffdd'},
  {name:'61 Cygni A',dist:11.86,spectral:'K5V',mag:5.21,x:10.8,y:5.2,constellation:'Cygnus',color:'#ffcc77'},
  {name:'61 Cygni B',dist:11.86,spectral:'K7V',mag:6.03,x:10.85,y:5.25,constellation:'Cygnus',color:'#ffcc88'},
  {name:'Struve 2398',dist:11.64,spectral:'M3V',mag:8.90,x:-6.8,y:-9.2,constellation:'Draco',color:'#ff6644'},
  {name:'Groombridge 34 A',dist:11.73,spectral:'M1V',mag:8.08,x:8.2,y:-8.5,constellation:'Andromeda',color:'#ff7744'},
  {name:'Epsilon Indi',dist:11.87,spectral:'K5V',mag:4.69,x:2.5,y:-11.5,constellation:'Indus',color:'#ffcc77'},
  {name:'Tau Ceti',dist:11.91,spectral:'G8.5V',mag:3.49,x:-10.8,y:-5.0,constellation:'Cetus',color:'#ffdd99'},
  {name:'Luyten\'s Star',dist:12.39,spectral:'M3.5V',mag:9.86,x:-9.8,y:7.8,constellation:'Canis Minor',color:'#ff5555'},
  {name:'Kapteyn\'s Star',dist:12.78,spectral:'M1V',mag:8.84,x:3.2,y:-12.2,constellation:'Pictor',color:'#ff7744'},
  {name:'Teegarden\'s Star',dist:12.49,spectral:'M6.5V',mag:15.45,x:-8.5,y:-9.0,constellation:'Aries',color:'#ff2222'},
  {name:'YZ Ceti',dist:12.13,spectral:'M4.5V',mag:12.07,x:11.5,y:-6.8,constellation:'Cetus',color:'#ff5555'},
  {name:'Altair',dist:16.73,spectral:'A7IV-V',mag:0.77,x:15.8,y:6.2,constellation:'Aquila',color:'#ffffdd'},
  {name:'Vega',dist:25.04,spectral:'A0V',mag:0.03,x:-18.0,y:17.5,constellation:'Lyra',color:'#e6f3ff'},
  {name:'Fomalhaut',dist:25.13,spectral:'A3V',mag:1.16,x:22.5,y:-11.0,constellation:'Piscis Austrinus',color:'#e6f3ff'},
  {name:'Pollux',dist:33.78,spectral:'K0IIIb',mag:1.14,x:32.0,y:9.8,constellation:'Gemini',color:'#ffcc66'},
  {name:'Arcturus',dist:36.7,spectral:'K1.5III',mag:-0.05,x:-25.0,y:26.5,constellation:'Bootes',color:'#ffcc66'},
  {name:'Castor',dist:51.0,spectral:'A1V',mag:1.58,x:49.0,y:14.8,constellation:'Gemini',color:'#e6f3ff'},
  {name:'Aldebaran',dist:65.3,spectral:'K5III',mag:0.87,x:55.0,y:-34.8,constellation:'Taurus',color:'#ff9944'},
  {name:'Regulus',dist:77.5,spectral:'B7V',mag:1.40,x:-60.0,y:48.0,constellation:'Leo',color:'#bbddff'},
  {name:'Polaris',dist:133.0,spectral:'F7Ib',mag:1.98,x:10.0,y:132.5,constellation:'Ursa Minor',color:'#ffffcc'},
  {name:'Antares',dist:170.0,spectral:'M1.5Iab',mag:0.96,x:-140.0,y:-96.0,constellation:'Scorpius',color:'#ff5533'},
  {name:'Canopus',dist:310.0,spectral:'A9II',mag:-0.74,x:150.0,y:-270.0,constellation:'Carina',color:'#ffffcc'},
  {name:'Betelgeuse',dist:700.0,spectral:'M2Iab',mag:0.42,x:-500.0,y:490.0,constellation:'Orion',color:'#ff7744'},
  {name:'Rigel',dist:860.0,spectral:'B8Ia',mag:0.13,x:600.0,y:-615.0,constellation:'Orion',color:'#6699ff'},
  {name:'Deneb',dist:2600.0,spectral:'A2Ia',mag:1.25,x:-1800.0,y:1880.0,constellation:'Cygnus',color:'#e6f3ff'}
];
var captainsLog = [];
var panelTitles = { ops:'OPERATIONS', tactical:'TACTICAL', science:'SCIENCE', comms:'COMMUNICATIONS', computer:'COMPUTER CORE', files:'DATABASE ACCESS', notepad:"CAPTAIN'S LOG", settings:'CONFIGURATION', starmap:'STELLAR CARTOGRAPHY' };

// === TAURI INVOKE HELPER ===
function tauriInvoke(cmd, args) {
  if (!isTauri) return Promise.reject('Not Tauri');
  return window.__TAURI_INTERNALS__.invoke(cmd, args || {});
}

// === AUDIO ===
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq, dur, type, vol) {
  if (!audioEnabled || !audioCtx) return;
  type = type || 'sine'; vol = vol || 0.15;
  var osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + dur);
}
function playBeep() { playTone(1200, 0.08, 'sine', 0.1); }
function playClick() { playTone(800, 0.04, 'square', 0.05); }
function playAlert(type) {
  if (type === 'red') { playTone(440,0.3,'sawtooth',0.2); setTimeout(function(){playTone(330,0.3,'sawtooth',0.2);},350); }
  else if (type === 'yellow') { playTone(660,0.2,'sine',0.15); setTimeout(function(){playTone(550,0.2,'sine',0.15);},250); }
}
function playTestTone() { initAudio(); audioEnabled=true; playTone(852,0.15,'sine',0.2); setTimeout(function(){playTone(1200,0.15,'sine',0.2);},180); setTimeout(function(){playTone(1600,0.3,'sine',0.15);},360); }
function playBoatswain() { initAudio(); audioEnabled=true; playTone(1047,0.15,'sine',0.2); setTimeout(function(){playTone(1319,0.12,'sine',0.2);},160); setTimeout(function(){playTone(1568,0.3,'sine',0.18);},300); setTimeout(function(){playTone(2093,0.5,'sine',0.12);},620); }
function playBootTick() { playTone(1800, 0.04, 'sine', 0.07); }
function playFrameBeep() { playTone(900, 0.06, 'sine', 0.08); }
function playSystemOnline() { initAudio(); playTone(880,0.12,'sine',0.15); setTimeout(function(){playTone(1320,0.12,'sine',0.15);},140); setTimeout(function(){playTone(1760,0.25,'sine',0.12);},280); }
function toggleSound() { initAudio(); audioEnabled=!audioEnabled; document.getElementById('soundToggle').textContent=audioEnabled?'DISABLE AUDIO':'ENABLE AUDIO'; if(audioEnabled) playBeep(); }

// === BOOT ===
function runBoot() {
  var bootScreen = document.getElementById('bootScreen');
  var mainFrame = document.getElementById('mainFrame');
  var progress = document.getElementById('bootProgress');

  // Hide main frame elements for animation
  var sidebar = document.querySelector('.lcars-sidebar');
  var header = document.querySelector('.lcars-header');
  var footer = document.querySelector('.lcars-footer');
  var content = document.querySelector('.lcars-content');
  sidebar.classList.add('boot-hidden');
  header.classList.add('boot-hidden');
  footer.classList.add('boot-hidden');
  content.classList.add('boot-hidden');

  // Dim all sidebar buttons, header segments, footer segments
  var sidebarBtns = document.querySelectorAll('.lcars-sidebar .sidebar-btn');
  var headerSegs = document.querySelectorAll('.header-segment');
  var footerSegs = document.querySelectorAll('.footer-segment');
  sidebarBtns.forEach(function(b){ b.classList.add('boot-dim'); });
  headerSegs.forEach(function(s){ s.classList.add('boot-dim'); });
  footerSegs.forEach(function(s){ s.classList.add('boot-dim'); });

  // === PHASE 1: Power Up (0-3s) ===
  var steps = ['bootTitle','boot1','boot2','boot3','boot4','boot5','boot6'];
  var i = 0;
  function phase1() {
    if (i < steps.length) {
      var el = document.getElementById(steps[i]);
      el.classList.add('visible');
      progress.style.width = ((i+1) / steps.length * 100) + '%';
      if (i === 0) { playBoatswain(); }
      else { playBootTick(); }
      i++;
      setTimeout(phase1, i === 1 ? 500 : 400);
    } else {
      setTimeout(phase2, 600);
    }
  }

  // === PHASE 2: Frame Assembly (3-6s) ===
  function phase2() {
    // Fade out boot screen
    bootScreen.style.transition = 'opacity 0.5s ease';
    bootScreen.style.opacity = '0';

    setTimeout(function() {
      bootScreen.classList.add('hidden');
      // Show main frame container
      mainFrame.style.opacity = '1';
      mainFrame.style.transition = 'none';

      // Stagger the frame elements in
      setTimeout(function() {
        sidebar.classList.remove('boot-hidden');
        sidebar.classList.add('boot-animate');
        playFrameBeep();
      }, 100);

      setTimeout(function() {
        header.classList.remove('boot-hidden');
        header.classList.add('boot-animate');
        playFrameBeep();
      }, 400);

      setTimeout(function() {
        footer.classList.remove('boot-hidden');
        footer.classList.add('boot-animate');
        playFrameBeep();
      }, 700);

      setTimeout(function() {
        content.classList.remove('boot-hidden');
        content.classList.add('boot-animate');
        playFrameBeep();
      }, 1000);

      // Move to phase 3 after frame is assembled
      setTimeout(phase3, 1400);
    }, 550);
  }

  // === PHASE 3: Systems Online (6-8s) ===
  function phase3() {
    // Light up sidebar buttons one by one
    var btnDelay = 0;
    sidebarBtns.forEach(function(btn) {
      setTimeout(function() {
        btn.classList.remove('boot-dim');
        btn.classList.add('boot-lit');
        playBootTick();
      }, btnDelay);
      btnDelay += 120;
    });

    // Light up header segments after buttons
    var segDelay = btnDelay + 100;
    headerSegs.forEach(function(seg) {
      setTimeout(function() {
        seg.classList.remove('boot-dim');
        seg.classList.add('boot-lit');
      }, segDelay);
      segDelay += 150;
    });

    // Light up footer segments
    footerSegs.forEach(function(seg) {
      setTimeout(function() {
        seg.classList.remove('boot-dim');
        seg.classList.add('boot-lit');
      }, segDelay);
      segDelay += 150;
    });

    // Final chime and start systems
    setTimeout(function() {
      playSystemOnline();
      // Clean up animation classes
      sidebar.classList.remove('boot-animate');
      header.classList.remove('boot-animate');
      footer.classList.remove('boot-animate');
      content.classList.remove('boot-animate');
      sidebarBtns.forEach(function(b){ b.classList.remove('boot-dim','boot-lit'); });
      headerSegs.forEach(function(s){ s.classList.remove('boot-dim','boot-lit'); });
      footerSegs.forEach(function(s){ s.classList.remove('boot-dim','boot-lit'); });
      startSystems();
    }, segDelay + 300);
  }

  phase1();
}

// === PANELS ===
function switchPanel(name) {
  playClick();
  document.querySelectorAll('.panel-container').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.sidebar-btn').forEach(function(b){b.classList.remove('active');});
  document.getElementById('panel-'+name).classList.add('active');
  document.getElementById('btn-'+name).classList.add('active');
  document.getElementById('panelTitle').textContent=panelTitles[name]||name.toUpperCase();
  currentPanel=name;
}

// === SYSTEM MONITORING ===
function updateSystems() {
  if (isTauri) {
    tauriInvoke('get_system_metrics').then(function(m) {
      var cpu=m.cpu_usage, mem=m.memory_usage_percent;
      var rxD=m.network_rx_bytes-lastRxBytes, txD=m.network_tx_bytes-lastTxBytes;
      lastRxBytes=m.network_rx_bytes; lastTxBytes=m.network_tx_bytes;
      var netMbps=((rxD+txD)*8)/1000000; var net=Math.min(100,netMbps);
      document.getElementById('cpuValue').textContent=cpu.toFixed(1)+'%';
      document.getElementById('cpuBar').style.width=cpu+'%';
      document.getElementById('memValue').textContent=m.memory_used.toFixed(1)+' / '+m.memory_total.toFixed(0)+' GB';
      document.getElementById('memBar').style.width=mem+'%';
      document.getElementById('netValue').textContent=netMbps.toFixed(1)+' Mb/s';
      document.getElementById('netBar').style.width=net+'%';
      var diskFree=100-m.disk_usage_percent;
      var diskFreeGB=((m.disk_total-m.disk_used)/1073741824).toFixed(0);
      var diskTotalGB=(m.disk_total/1073741824).toFixed(0);
      document.getElementById('warpPower').textContent=diskFreeGB+' / '+diskTotalGB+' GB';
      var wb=document.getElementById('warpBar'); if(wb) wb.style.width=diskFree+'%';
      if (m.battery_percent !== undefined && m.battery_percent >= 0) {
        document.getElementById('impulsePower').textContent=m.battery_percent.toFixed(0)+'%'+(m.battery_charging?' ‚ö°':'');
        var ib=document.getElementById('impulseBar'); if(ib) ib.style.width=m.battery_percent+'%';
      } else {
        document.getElementById('impulsePower').textContent='AC POWER';
        var ib=document.getElementById('impulseBar'); if(ib) ib.style.width='100%';
      }
      document.getElementById('auxPower').textContent=(m.thermal_pressure||'NOMINAL');
      var u=m.uptime_seconds, d=Math.floor(u/86400), h=Math.floor((u%86400)/3600), mn=Math.floor((u%3600)/60);
      document.getElementById('uptimeValue').textContent=d+'d '+h+'h '+mn+'m';
      if(m.cpu_brand&&m.cpu_brand!=='Unknown'){var hdr=document.querySelector('#panel-ops .panel.blue .panel-header');if(hdr)hdr.textContent=m.cpu_brand;}
      cpuHistory.push(Math.max(0,Math.min(100,cpu))); cpuHistory.shift();
      memHistory.push(Math.max(0,Math.min(100,mem))); memHistory.shift();
      netHistory.push(Math.max(0,Math.min(100,net))); netHistory.shift();
      drawGraph('cpuGraph',cpuHistory,'rgba(102,136,204,0.8)','rgba(102,136,204,0.1)');
      drawGraph('memGraph',memHistory,'rgba(102,204,204,0.8)','rgba(102,204,204,0.1)');
      drawGraph('netGraph',netHistory,'rgba(204,119,255,0.8)','rgba(204,119,255,0.1)');
      updateShipDiagram(cpu, mem, diskFree, m.battery_percent !== undefined ? m.battery_percent : -1, netMbps);
    }).catch(function(e){ console.warn('Tauri metrics error:',e); updateSystemsSimulated(); });
  } else {
    updateSystemsSimulated();
  }
}

function shipColor(pct) {
  // green < 60, yellow 60-80, red > 80
  if (pct < 60) return '#44cc66';
  if (pct < 80) return '#ccaa33';
  return '#cc4444';
}
function updateShipDiagram(cpu, mem, disk, batt, net) {
  // No-op: ship diagram removed, metrics shown in sidebar
}

function updateSystemsSimulated() {
  var cpu=15+Math.random()*40+Math.sin(Date.now()/3000)*10;
  var mem=45+Math.random()*10+Math.sin(Date.now()/8000)*8;
  var net=20+Math.random()*60;
  cpuHistory.push(Math.max(0,Math.min(100,cpu))); cpuHistory.shift();
  memHistory.push(Math.max(0,Math.min(100,mem))); memHistory.shift();
  netHistory.push(Math.max(0,Math.min(100,net))); netHistory.shift();
  document.getElementById('cpuValue').textContent=cpu.toFixed(1)+'%';
  document.getElementById('cpuBar').style.width=cpu+'%';
  document.getElementById('memValue').textContent='SIM ‚Äî no backend';
  document.getElementById('memBar').style.width=mem+'%';
  document.getElementById('netValue').textContent='SIM';
  document.getElementById('netBar').style.width=net+'%';
  document.getElementById('warpPower').textContent='SIM ‚Äî no backend';
  document.getElementById('impulsePower').textContent='SIM';
  document.getElementById('auxPower').textContent='SIM';
  var up=Date.now()-bootStartTime, h=Math.floor(up/3600000), m2=Math.floor((up%3600000)/60000), s=Math.floor((up%60000)/1000);
  document.getElementById('uptimeValue').textContent='0d '+h+'h '+m2+'m';
  drawGraph('cpuGraph',cpuHistory,'rgba(102,136,204,0.8)','rgba(102,136,204,0.1)');
  drawGraph('memGraph',memHistory,'rgba(102,204,204,0.8)','rgba(102,204,204,0.1)');
  drawGraph('netGraph',netHistory,'rgba(204,119,255,0.8)','rgba(204,119,255,0.1)');
  updateShipDiagram(cpu, mem, 95, -1, net*1.2);
}

function drawGraph(canvasId, data, lineColor, fillColor) {
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  var ctx=canvas.getContext('2d'), w=canvas.width=canvas.offsetWidth*2, h=canvas.height=canvas.offsetHeight*2;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='rgba(102,136,204,0.08)'; ctx.lineWidth=1;
  for(var i=0;i<5;i++){var y=(h/5)*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  ctx.strokeStyle=lineColor; ctx.lineWidth=3; ctx.lineJoin='round'; ctx.beginPath();
  for(var i=0;i<data.length;i++){var x=(w/(data.length-1))*i,y2=h-(data[i]/100)*h;if(i===0)ctx.moveTo(x,y2);else ctx.lineTo(x,y2);}
  ctx.stroke(); ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fillStyle=fillColor; ctx.fill();
}

// === SENSOR ===
function drawSensor() {
  var canvas=document.getElementById('sensorCanvas'); if(!canvas)return;
  var ctx=canvas.getContext('2d'), cx=120,cy=120,r=110;
  ctx.clearRect(0,0,240,240);
  ctx.strokeStyle='rgba(102,136,204,0.15)'; ctx.lineWidth=1;
  for(var i=1;i<=4;i++){ctx.beginPath();ctx.arc(cx,cy,(r/4)*i,0,Math.PI*2);ctx.stroke();}
  ctx.beginPath();ctx.moveTo(cx-r,cy);ctx.lineTo(cx+r,cy);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx,cy-r);ctx.lineTo(cx,cy+r);ctx.stroke();
  ctx.fillStyle='rgba(0,204,204,0.12)';ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,sensorAngle-0.5,sensorAngle,false);ctx.closePath();ctx.fill();
  ctx.strokeStyle='rgba(0,204,204,0.8)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(sensorAngle)*r,cy+Math.sin(sensorAngle)*r);ctx.stroke();
  ctx.fillStyle='#00cccc';ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fill();
  if(Math.random()>0.95){var a=Math.random()*Math.PI*2,br=20+Math.random()*80;blips.push({x:cx+Math.cos(a)*br,y:cy+Math.sin(a)*br,life:60});}
  blips=blips.filter(function(b){return b.life>0;});
  blips.forEach(function(b){ctx.fillStyle='rgba(0,204,204,'+(b.life/60)+')';ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();b.life--;});
  sensorAngle+=0.03;
}

// === ASTROMETRICS ===
function initStarfield3D() { stars=[]; for(var i=0;i<300;i++) stars.push({x:Math.random()*2-1,y:Math.random()*2-1,z:Math.random(),size:0.5+Math.random()*1.5}); }
function drawAstrometrics() {
  var canvas=document.getElementById('astrometricsCanvas'); if(!canvas)return;
  var ctx=canvas.getContext('2d'), w=canvas.width, h=canvas.height;
  ctx.fillStyle='rgba(0,5,15,0.3)'; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='rgba(102,136,204,0.06)'; ctx.lineWidth=1;
  for(var x=0;x<w;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(var y=0;y<h;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  stars.forEach(function(s){
    s.z-=0.002; if(s.z<=0){s.z=1;s.x=Math.random()*2-1;s.y=Math.random()*2-1;}
    var sx=(s.x/s.z)*300+w/2, sy=(s.y/s.z)*150+h/2, sz=(1-s.z)*s.size*2, br=1-s.z;
    if(sx>0&&sx<w&&sy>0&&sy<h){ctx.fillStyle='rgba(153,204,255,'+br+')';ctx.beginPath();ctx.arc(sx,sy,sz,0,Math.PI*2);ctx.fill();}
  });
}

// === BACKGROUND STARFIELD ===
function initBgStarfield() {
  var canvas=document.getElementById('starfield'); canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  bgStars=[]; for(var i=0;i<200;i++) bgStars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:0.3+Math.random()*1.2,a:0.2+Math.random()*0.6,twinkle:Math.random()*Math.PI*2,speed:0.5+Math.random()*2});
  function resetActivity(){lastActivity=Date.now();if(warpMode){warpMode=false;}}
  document.addEventListener('mousemove',resetActivity);
  document.addEventListener('keydown',resetActivity);
  document.addEventListener('mousedown',resetActivity);
}
function drawBgStarfield() {
  var canvas=document.getElementById('starfield'), ctx=canvas.getContext('2d');
  var w=canvas.width, h=canvas.height;
  if(!warpMode && Date.now()-lastActivity>WARP_IDLE_MS) warpMode=true;
  // Ramp warp speed up/down
  if(warpMode && warpSpeed<1) warpSpeed=Math.min(1, warpSpeed+0.08);
  if(!warpMode && warpSpeed>0) warpSpeed=Math.max(0, warpSpeed-0.05);
  // Bring starfield to front during warp
  if(warpSpeed>0.01){
    canvas.style.zIndex='9999';
    canvas.style.opacity=String(Math.min(1, warpSpeed*1.5));
  } else {
    canvas.style.zIndex='-1';
    canvas.style.opacity='0.3';
  }
  var cx=w/2, cy=h/2;
  if(warpSpeed>0.01){
    ctx.fillStyle='rgba(0,2,8,0.12)';
    ctx.fillRect(0,0,w,h);
    bgStars.forEach(function(s){
      var dx=s.x-cx, dy=s.y-cy;
      var dist=Math.sqrt(dx*dx+dy*dy)||1;
      s.x+=dx/dist*s.speed*warpSpeed*6;
      s.y+=dy/dist*s.speed*warpSpeed*6;
      if(s.x<-10||s.x>w+10||s.y<-10||s.y>h+10){s.x=cx+(Math.random()-0.5)*80;s.y=cy+(Math.random()-0.5)*80;}
      var len=warpSpeed*s.speed*30;
      ctx.strokeStyle='rgba(180,210,255,'+(s.a*warpSpeed)+')';
      ctx.lineWidth=s.r*0.7;
      ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+dx/dist*len,s.y+dy/dist*len);ctx.stroke();
    });
  } else {
    ctx.clearRect(0,0,w,h);
    bgStars.forEach(function(s){
      s.twinkle+=0.02+Math.random()*0.01;
      var alpha=s.a*(0.5+0.5*Math.sin(s.twinkle));
      ctx.fillStyle='rgba(180,210,255,'+alpha+')';
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
    });
  }
}

// === CLOCK ===
function updateClock() {
  var now=new Date(), h=String(now.getHours()).padStart(2,'0'), m=String(now.getMinutes()).padStart(2,'0'), s=String(now.getSeconds()).padStart(2,'0');
  var timeStr=h+':'+m+':'+s;
  document.getElementById('headerTime').textContent=timeStr;
  var ct=document.getElementById('clockTime'); if(ct)ct.textContent=timeStr;
  var elapsed=(now-new Date('2000-01-01'))/(1000*60*60*24*365.25);
  var stardate=(41000+elapsed*1000).toFixed(1);
  document.getElementById('headerStardate').textContent='SD '+stardate;
  var days=['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  var months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  var dateStr=days[now.getDay()]+' '+now.getDate()+' '+months[now.getMonth()]+' '+now.getFullYear();
  var cd=document.getElementById('clockDate'); if(cd)cd.textContent=dateStr;
  updateTimeTheme();
  var cs=document.getElementById('clockStardate'); if(cs)cs.textContent='STARDATE '+stardate;
  drawAnalogClock(now);
}
function drawAnalogClock(now) {
  var canvas=document.getElementById('clockCanvas'); if(!canvas)return;
  var ctx=canvas.getContext('2d'), cx=100,cy=100,r=90;
  ctx.clearRect(0,0,200,200);
  ctx.strokeStyle='rgba(102,136,204,0.3)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
  for(var i=0;i<12;i++){var angle=(Math.PI*2/12)*i-Math.PI/2,inner=i%3===0?r-15:r-10;ctx.strokeStyle=i%3===0?'#99ccff':'rgba(102,136,204,0.4)';ctx.lineWidth=i%3===0?3:1;ctx.beginPath();ctx.moveTo(cx+Math.cos(angle)*inner,cy+Math.sin(angle)*inner);ctx.lineTo(cx+Math.cos(angle)*(r-2),cy+Math.sin(angle)*(r-2));ctx.stroke();}
  var hr=(now.getHours()%12+now.getMinutes()/60)*(Math.PI*2/12)-Math.PI/2;
  ctx.strokeStyle='#99ccff';ctx.lineWidth=4;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(hr)*50,cy+Math.sin(hr)*50);ctx.stroke();
  var mn=(now.getMinutes()+now.getSeconds()/60)*(Math.PI*2/60)-Math.PI/2;
  ctx.strokeStyle='#66cccc';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(mn)*70,cy+Math.sin(mn)*70);ctx.stroke();
  var sc=now.getSeconds()*(Math.PI*2/60)-Math.PI/2;
  ctx.strokeStyle='#ff9900';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(sc)*80,cy+Math.sin(sc)*80);ctx.stroke();
  ctx.fillStyle='#99ccff';ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fill();
}

// === CALCULATOR ===
function calcInput(val){playClick();calcExpression+=val;document.getElementById('calcDisplay').textContent=calcExpression||'0';}
function calcClear(){playClick();calcExpression='';document.getElementById('calcDisplay').textContent='0';}
function calcEquals(){playBeep();try{var result=Function('"use strict";return ('+calcExpression+')')();document.getElementById('calcDisplay').textContent=result;calcExpression=String(result);}catch(e){document.getElementById('calcDisplay').textContent='ERROR';calcExpression='';}}

// === STAR MAP ===
var starMapZoom = 2.5, starMapPanX = 0, starMapPanY = 0;
var starMapDragging = false, starMapDragX = 0, starMapDragY = 0;
var starMapSelected = null, starMapTime = 0;

function initStarMap() {
  var c = document.getElementById('starMapCanvas');
  if (!c) return;
  window.addEventListener('resize', resizeStarMap);
  c.addEventListener('mousedown', function(e) { starMapDragging = true; starMapDragX = e.clientX; starMapDragY = e.clientY; });
  c.addEventListener('mousemove', function(e) {
    if (!starMapDragging) return;
    starMapPanX += e.clientX - starMapDragX; starMapPanY += e.clientY - starMapDragY;
    starMapDragX = e.clientX; starMapDragY = e.clientY;
  });
  c.addEventListener('mouseup', function() { starMapDragging = false; });
  c.addEventListener('mouseleave', function() { starMapDragging = false; });
  c.addEventListener('wheel', function(e) {
    e.preventDefault();
    var old = starMapZoom;
    starMapZoom = Math.max(0.2, Math.min(25.0, starMapZoom * (e.deltaY > 0 ? 0.9 : 1.1)));
    var r = starMapZoom / old;
    starMapPanX *= r; starMapPanY *= r;
  }, {passive: false});
  c.addEventListener('click', function(e) {
    var rect = c.getBoundingClientRect();
    var mx = e.clientX - rect.left, my = e.clientY - rect.top;
    var dpr = window.devicePixelRatio || 1;
    var w = c.width / dpr, h = c.height / dpr, cx = w / 2, cy = h / 2;
    var hit = null, best = 20;
    starMapData.forEach(function(s) {
      var sx = cx + s.x * 3 * starMapZoom + starMapPanX;
      var sy = cy + s.y * 3 * starMapZoom + starMapPanY;
      var d = Math.sqrt((mx - sx) * (mx - sx) + (my - sy) * (my - sy));
      if (d < best) { best = d; hit = s; }
    });
    if (hit) { starMapSelected = hit.name; showStarInfo(hit); playClick(); }
    else { closeStarInfo(); }
  });
}

function resizeStarMap() {
  var c = document.getElementById('starMapCanvas');
  if (!c) return;
  var dpr = window.devicePixelRatio || 1;
  var ow = c.offsetWidth, oh = c.offsetHeight;
  if (ow > 0 && oh > 0 && (c.width !== ow * dpr || c.height !== oh * dpr)) {
    c.width = ow * dpr;
    c.height = oh * dpr;
  }
}

function drawStarMap() {
  var c = document.getElementById('starMapCanvas');
  if (!c || !document.getElementById('panel-starmap').classList.contains('active')) return;
  resizeStarMap();
  var ctx = c.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var w = c.width / dpr, h = c.height / dpr;
  if (w < 1 || h < 1) return;
  ctx.save();
  ctx.scale(dpr, dpr);
  var cx = w / 2, cy = h / 2;

  // Background
  ctx.fillStyle = 'rgba(0,5,15,1)';
  ctx.fillRect(0, 0, w, h);

  // Grid
  ctx.strokeStyle = 'rgba(102,136,204,0.07)';
  ctx.lineWidth = 0.5;
  var gs = 50 * starMapZoom;
  if (gs > 10) {
    var ox = ((cx + starMapPanX) % gs + gs) % gs;
    var oy = ((cy + starMapPanY) % gs + gs) % gs;
    for (var gx = ox; gx < w; gx += gs) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
    for (var gy = oy; gy < h; gy += gs) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
  }

  // Distance rings from Sol
  ctx.strokeStyle = 'rgba(204,102,204,0.12)';
  ctx.setLineDash([4, 8]);
  var solX = cx + starMapPanX, solY = cy + starMapPanY;
  [5, 10, 15, 20].forEach(function(ly) {
    var r = ly * 3 * starMapZoom;
    if (r > 5 && r < Math.max(w, h) * 2) {
      ctx.beginPath(); ctx.arc(solX, solY, r, 0, Math.PI * 2); ctx.stroke();
      ctx.fillStyle = 'rgba(204,102,204,0.3)';
      ctx.font = '9px sans-serif';
      ctx.fillText(ly + ' LY', solX + r + 4, solY - 3);
    }
  });
  ctx.setLineDash([]);

  // Subspace relay network (connections within 8 LY between nearby stars)
  ctx.strokeStyle = 'rgba(0,204,204,0.08)';
  ctx.lineWidth = 0.8;
  for (var i = 0; i < starMapData.length; i++) {
    if (starMapData[i].dist > 25) continue;
    for (var j = i + 1; j < starMapData.length; j++) {
      if (starMapData[j].dist > 25) continue;
      var dx = starMapData[i].x - starMapData[j].x, dy = starMapData[i].y - starMapData[j].y;
      var dd = Math.sqrt(dx * dx + dy * dy);
      if (dd > 0 && dd < 8) {
        var x1 = cx + starMapData[i].x * 3 * starMapZoom + starMapPanX;
        var y1 = cy + starMapData[i].y * 3 * starMapZoom + starMapPanY;
        var x2 = cx + starMapData[j].x * 3 * starMapZoom + starMapPanX;
        var y2 = cy + starMapData[j].y * 3 * starMapZoom + starMapPanY;
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
      }
    }
  }

  // Stars
  starMapTime += 0.016;
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  starMapData.forEach(function(s, idx) {
    var sx = cx + s.x * 3 * starMapZoom + starMapPanX;
    var sy = cy + s.y * 3 * starMapZoom + starMapPanY;
    if (sx < -50 || sx > w + 50 || sy < -50 || sy > h + 50) return;

    var size = Math.max(1.5, (3 - s.mag / 5) * Math.max(0.5, starMapZoom * 0.5));
    var pulse = 0.85 + 0.15 * Math.sin(starMapTime * 2 + idx * 1.7);

    // Selection ring
    if (starMapSelected === s.name) {
      ctx.strokeStyle = 'rgba(204,102,204,0.8)';
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.arc(sx, sy, size + 8, 0, Math.PI * 2); ctx.stroke();
    }

    // Glow
    ctx.globalAlpha = pulse * 0.3;
    ctx.fillStyle = s.color;
    ctx.beginPath(); ctx.arc(sx, sy, size * 2.5, 0, Math.PI * 2); ctx.fill();

    // Core
    ctx.globalAlpha = pulse;
    ctx.fillStyle = s.color;
    ctx.beginPath(); ctx.arc(sx, sy, size, 0, Math.PI * 2); ctx.fill();
    ctx.globalAlpha = 1.0;

    // Labels
    var showLabel = (s.name === 'Sol' || s.dist < 13 || s.mag < 1.5);
    if (showLabel && starMapZoom > 0.4) {
      ctx.fillStyle = 'rgba(102,204,204,0.65)';
      ctx.font = (s.name === 'Sol' ? 'bold 12px' : '10px') + ' sans-serif';
      ctx.fillText(s.name, sx + size + 5, sy);
    }
  });

  // Sol crosshair
  ctx.strokeStyle = 'rgba(255,255,0,0.2)';
  ctx.lineWidth = 0.5;
  ctx.beginPath(); ctx.moveTo(solX - 15, solY); ctx.lineTo(solX + 15, solY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(solX, solY - 15); ctx.lineTo(solX, solY + 15); ctx.stroke();

  ctx.restore();

  // Update status bar
  var el = document.getElementById('starMapCoords');
  if (el) el.textContent = 'Range: \u00b1' + (50 / starMapZoom).toFixed(1) + ' LY | Zoom: ' + starMapZoom.toFixed(1) + 'x';
}

function showStarInfo(s) {
  document.getElementById('starMapName').textContent = s.name;
  document.getElementById('starMapDistance').textContent = 'Distance: ' + (s.dist === 0 ? 'SOL (origin)' : s.dist.toFixed(2) + ' light-years');
  document.getElementById('starMapSpectral').textContent = 'Spectral class: ' + s.spectral;
  document.getElementById('starMapMagnitude').textContent = 'Apparent mag: ' + s.mag.toFixed(2);
  document.getElementById('starMapConstellation').textContent = s.constellation;
  document.getElementById('starMapInfo').style.display = 'block';
}

function closeStarInfo() {
  document.getElementById('starMapInfo').style.display = 'none';
  starMapSelected = null;
}

// === FILE BROWSER (Real via Tauri) ===
function navigateUp() {
  if (!currentPath || currentPath === '/') return;
  var parts = currentPath.replace(/\/$/,'').split('/');
  parts.pop();
  currentPath = parts.join('/') || '/';
  if (currentPath.length > 1 && currentPath.charAt(currentPath.length-1) !== '/') currentPath += '/';
  loadDirectory(currentPath);
}

function loadDirectory(path) {
  if (isTauri) {
    tauriInvoke('list_directory', { path: path }).then(function(entries) {
      currentPath = path;
      document.getElementById('filePath').textContent = currentPath;
      var list = document.getElementById('fileList');
      list.innerHTML = '';
      if (currentPath !== '/' && currentPath.length > 1) {
        var upDiv = document.createElement('div'); upDiv.className='file-item';
        upDiv.onclick = function(){ playClick(); navigateUp(); };
        upDiv.innerHTML='<span class="file-icon">‚¨ÜÔ∏è</span><span class="file-name">..</span><span class="file-size">‚Äî</span><span class="file-date">‚Äî</span>';
        list.appendChild(upDiv);
      }
      entries.sort(function(a,b){ if(a.is_dir && !b.is_dir) return -1; if(!a.is_dir && b.is_dir) return 1; return a.name.localeCompare(b.name); });
      entries.forEach(function(entry) {
        var div = document.createElement('div'); div.className='file-item';
        if (entry.is_dir) {
          div.onclick = function(){ playClick(); loadDirectory(entry.path); };
        } else {
          div.onclick = function(){ playClick(); tauriInvoke('open_file', { path: entry.path }).catch(function(e){ console.warn('open_file error:',e); }); };
        }
        var icon = entry.is_dir ? 'üìÅ' : (entry.name.match(/\.(jpg|jpeg|png|gif|svg)$/i) ? 'üñºÔ∏è' : entry.name.match(/\.(mp3|wav|aac|m4a)$/i) ? 'üéµ' : entry.name.match(/\.(mp4|mov|avi)$/i) ? 'üé¨' : entry.name.match(/\.(pdf)$/i) ? 'üìï' : entry.name.match(/\.(zip|tar|gz|dmg)$/i) ? 'üì¶' : entry.name.match(/\.(js|ts|py|rs|swift|c|cpp|h|java|go|rb)$/i) ? 'üíª' : 'üìÑ');
        var sizeStr = entry.is_dir ? '‚Äî' : formatFileSize(entry.size);
        div.innerHTML='<span class="file-icon">'+icon+'</span><span class="file-name">'+entry.name+'</span><span class="file-size">'+sizeStr+'</span>';
        list.appendChild(div);
      });
    }).catch(function(e){ console.warn('list_directory error:',e); });
  }
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  if (bytes < 1073741824) return (bytes/1048576).toFixed(1) + ' MB';
  return (bytes/1073741824).toFixed(1) + ' GB';
}

function initFilesBrowser() {
  if (isTauri) {
    tauriInvoke('get_home_dir').then(function(home) {
      currentPath = home;
      loadDirectory(currentPath);
    }).catch(function(e){ console.warn('get_home_dir error:',e); });
  }
}

// === TASK LIST (with due dates) ===
function loadTasks() {
  if (isTauri) {
    tauriInvoke('load_tasks').then(function(data) {
      try { tasks = JSON.parse(data); } catch(e) { tasks = []; }
      renderTasks();
    }).catch(function(e){ tasks=[]; renderTasks(); });
  } else {
    tasks = []; renderTasks();
  }
}

function saveTasks() {
  if (isTauri) {
    tauriInvoke('save_tasks', { data: JSON.stringify(tasks) }).catch(function(e){ console.warn('save_tasks error:',e); });
  }
}

// === CAPTAIN'S LOG ===
function loadLog() {
  if (isTauri) {
    tauriInvoke('load_log').then(function(data) {
      try { captainsLog = JSON.parse(data); } catch(e) { captainsLog = []; }
      renderLog();
    }).catch(function(){ captainsLog = []; renderLog(); });
  } else {
    captainsLog = []; renderLog();
  }
}

function saveLog() {
  if (isTauri) {
    tauriInvoke('save_log', { data: JSON.stringify(captainsLog) }).catch(function(e){ console.warn('save_log error:',e); });
  }
}

function getStardate() {
  var now = new Date();
  var start = new Date(now.getFullYear(), 0, 1);
  var day = Math.floor((now - start) / 86400000);
  var frac = (day / 365 * 1000).toFixed(1);
  return (now.getFullYear() - 1947) + frac;
}

function addLogEntry() {
  var textarea = document.getElementById('logEntry');
  var text = textarea.value.trim();
  if (!text) return;
  playBeep();
  captainsLog.unshift({ stardate: getStardate(), text: text, time: new Date().toISOString() });
  textarea.value = '';
  saveLog();
  renderLog();
}

function deleteLogEntry(idx) {
  captainsLog.splice(idx, 1);
  saveLog();
  renderLog();
}

function clearAllLogs() {
  if (captainsLog.length === 0) return;
  captainsLog = [];
  saveLog();
  renderLog();
  playClick();
}

function renderLog() {
  var container = document.getElementById('logEntries');
  if (!container) return;
  if (captainsLog.length === 0) {
    container.innerHTML = '<div style="color:var(--lcars-lavender);opacity:0.5;padding:10px;">No log entries recorded.</div>';
    return;
  }
  var html = '';
  captainsLog.forEach(function(entry, idx) {
    var d = new Date(entry.time);
    var timeStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    html += '<div style="border-left:3px solid var(--lcars-purple);padding:8px 12px;margin-bottom:8px;background:rgba(204,119,255,0.05);border-radius:0 6px 6px 0;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
    html += '<span style="color:var(--lcars-purple);font-weight:700;font-size:12px;letter-spacing:1px;">STARDATE ' + entry.stardate + '</span>';
    html += '<span style="color:var(--lcars-lavender);font-size:10px;">' + timeStr + '</span>';
    html += '</div>';
    html += '<div style="color:var(--lcars-lightblue);font-size:13px;line-height:1.5;">' + entry.text.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</div>';
    html += '<button onclick="deleteLogEntry(' + idx + ')" style="background:none;border:none;color:var(--lcars-red);cursor:pointer;font-size:10px;padding:4px 0;margin-top:4px;font-family:inherit;letter-spacing:1px;">DELETE</button>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function addTask() {
  var input = document.getElementById('taskInput');
  var text = input.value.trim();
  if (!text) return;
  playClick();
  var priority = document.getElementById('taskPriority').value;
  var dueDateInput = document.getElementById('taskDueDate');
  var dueDate = dueDateInput.value || '';
  tasks.push({ text: text, priority: priority, completed: false, created: Date.now(), dueDate: dueDate });
  input.value = '';
  dueDateInput.value = '';
  saveTasks();
  renderTasks();
}

function toggleTask(index) {
  playClick();
  tasks[index].completed = !tasks[index].completed;
  saveTasks();
  renderTasks();
}

function deleteTask(index) {
  playClick();
  tasks.splice(index, 1);
  saveTasks();
  renderTasks();
}

function setTaskFilter(f) {
  taskFilter = f;
  document.querySelectorAll('.task-filter-btn').forEach(function(b){ b.classList.remove('active'); });
  var btn = document.getElementById('filter' + f.charAt(0).toUpperCase() + f.slice(1));
  if (btn) btn.classList.add('active');
  renderTasks();
}

function purgeCompleted() {
  playBeep();
  tasks = tasks.filter(function(t){ return !t.completed; });
  saveTasks();
  renderTasks();
}

function isOverdue(task) {
  if (!task.dueDate || task.completed) return false;
  var today = new Date();
  today.setHours(0,0,0,0);
  var due = new Date(task.dueDate + 'T00:00:00');
  return due < today;
}

function isDueSoon(task) {
  if (!task.dueDate || task.completed) return false;
  var today = new Date();
  today.setHours(0,0,0,0);
  var due = new Date(task.dueDate + 'T00:00:00');
  var diff = (due - today) / (1000*60*60*24);
  return diff >= 0 && diff <= 2;
}

function formatDueDate(dateStr) {
  if (!dateStr) return '';
  var parts = dateStr.split('-');
  var months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  var m = parseInt(parts[1], 10) - 1;
  var d = parseInt(parts[2], 10);
  return d + ' ' + months[m];
}

function renderTasks() {
  var list = document.getElementById('taskList');
  if (!list) return;
  list.innerHTML = '';
  var filtered = tasks.filter(function(t) {
    if (taskFilter === 'active') return !t.completed;
    if (taskFilter === 'completed') return t.completed;
    if (taskFilter === 'overdue') return isOverdue(t);
    return true;
  });
  filtered.forEach(function(t) {
    var realIndex = tasks.indexOf(t);
    var overdue = isOverdue(t);
    var dueSoon = isDueSoon(t);
    var div = document.createElement('div');
    div.className = 'task-item' + (t.completed ? ' completed' : '') + (overdue ? ' overdue' : '');
    var dueDateHtml = '';
    if (t.dueDate) {
      var dueClass = 'task-due';
      var duePrefix = '';
      if (overdue) { duePrefix = '‚ö† '; }
      else if (dueSoon) { duePrefix = '‚è∞ '; }
      dueDateHtml = '<span class="' + dueClass + '">' + duePrefix + formatDueDate(t.dueDate) + '</span>';
    }
    div.innerHTML = '<div class="task-check' + (t.completed ? ' done' : '') + '" onclick="toggleTask(' + realIndex + ')">' + (t.completed ? '‚úì' : '') + '</div>' +
      '<span class="task-text">' + t.text + '</span>' +
      dueDateHtml +
      '<span class="task-priority ' + t.priority + '">' + t.priority.toUpperCase() + '</span>' +
      '<span class="task-delete" onclick="deleteTask(' + realIndex + ')">‚úï</span>';
    list.appendChild(div);
  });
  var total = tasks.length, done = tasks.filter(function(t){return t.completed;}).length;
  var overdueCount = tasks.filter(function(t){ return isOverdue(t); }).length;
  var stats = document.getElementById('taskStats');
  var statsText = done + ' of ' + total + ' tasks completed';
  if (overdueCount > 0) statsText += ' ‚Äî ' + overdueCount + ' overdue';
  if (stats) stats.textContent = statsText;
}

// === ALERTS ===
function triggerAlert(type) {
  playAlert(type); var bar=document.getElementById('alertBar'), footer=document.getElementById('footerAlert');
  if(type==='clear'){bar.classList.remove('show');footer.textContent='ALL CLEAR';footer.style.color='';document.getElementById('footerStatus').textContent='LCARS INTERFACE ACTIVE ‚Äî ALL SYSTEMS NOMINAL';return;}
  bar.className='alert-bar '+type+' show';
  if(type==='red'){bar.textContent='RED ALERT ‚Äî ALL HANDS TO BATTLE STATIONS';footer.textContent='RED ALERT';footer.style.color='#fff';}
  else if(type==='yellow'){bar.textContent='YELLOW ALERT ‚Äî INCREASED READINESS';footer.textContent='YELLOW ALERT';}
  else if(type==='blue'){bar.textContent='BLUE ALERT ‚Äî LANDING SEQUENCE INITIATED';footer.textContent='BLUE ALERT';}
  document.getElementById('footerStatus').textContent=bar.textContent;
  clearTimeout(alertTimeout); alertTimeout=setTimeout(function(){bar.classList.remove('show');},8000);
}

// === THEMES ===
var manualTheme = false;
function setTheme(theme) {
  playClick(); manualTheme = (theme !== 'voyager'); var r=document.documentElement;
  if(theme==='tng'){r.style.setProperty('--lcars-blue','#9977aa');r.style.setProperty('--lcars-lightblue','#eebb88');r.style.setProperty('--lcars-teal','#cc7744');r.style.setProperty('--lcars-purple','#7777aa');}
  else if(theme==='dark'){r.style.setProperty('--lcars-blue','#1a3355');r.style.setProperty('--lcars-lightblue','#5577aa');r.style.setProperty('--lcars-teal','#2a5555');r.style.setProperty('--lcars-purple','#443366');r.style.setProperty('--lcars-orange','#774422');}
  else if(theme==='snw'){r.style.setProperty('--lcars-blue','#4466aa');r.style.setProperty('--lcars-lightblue','#88aadd');r.style.setProperty('--lcars-teal','#449999');r.style.setProperty('--lcars-purple','#6655aa');r.style.setProperty('--lcars-orange','#bb6622');r.style.setProperty('--lcars-gold','#998822');}
  else{manualTheme=false;r.style.setProperty('--lcars-blue','#2f78ff');r.style.setProperty('--lcars-lightblue','#cfe8ff');r.style.setProperty('--lcars-teal','#7bd7c6');r.style.setProperty('--lcars-purple','#8a6dff');r.style.setProperty('--lcars-orange','#d06b12');r.style.setProperty('--lcars-gold','#b88910');}
}

function updateTimeTheme() {
  if (manualTheme) return;
  var hour = new Date().getHours();
  var r = document.documentElement;
  // Night (22-5): cool blues, dimmer
  // Morning (6-9): warming up
  // Day (10-17): standard bright (index2 palette)
  // Evening (18-21): warm amber/gold
  if (hour >= 22 || hour < 5) {
    r.style.setProperty('--lcars-orange','#8a5522');
    r.style.setProperty('--lcars-gold','#7a6618');
    r.style.setProperty('--lcars-lightblue','#7a9ab8');
    r.style.setProperty('--lcars-teal','#4a8a7a');
    r.style.setProperty('--lcars-blue','#2255aa');
    r.style.setProperty('--lcars-purple','#5a4a99');
    r.style.setProperty('--lcars-text','#8aaabb');
  } else if (hour >= 5 && hour < 9) {
    r.style.setProperty('--lcars-orange','#bb7722');
    r.style.setProperty('--lcars-gold','#9a7a18');
    r.style.setProperty('--lcars-lightblue','#a0c0dd');
    r.style.setProperty('--lcars-teal','#5aaa99');
    r.style.setProperty('--lcars-blue','#2a66cc');
    r.style.setProperty('--lcars-purple','#6a5aaa');
    r.style.setProperty('--lcars-text','#b0ccdd');
  } else if (hour >= 18 && hour < 22) {
    r.style.setProperty('--lcars-orange','#dd8822');
    r.style.setProperty('--lcars-gold','#cc9a22');
    r.style.setProperty('--lcars-lightblue','#b0ccdd');
    r.style.setProperty('--lcars-teal','#66bb99');
    r.style.setProperty('--lcars-blue','#3366cc');
    r.style.setProperty('--lcars-purple','#7766bb');
    r.style.setProperty('--lcars-text','#ccddee');
  } else {
    r.style.setProperty('--lcars-orange','#d06b12');
    r.style.setProperty('--lcars-gold','#b88910');
    r.style.setProperty('--lcars-lightblue','#cfe8ff');
    r.style.setProperty('--lcars-teal','#7bd7c6');
    r.style.setProperty('--lcars-blue','#2f78ff');
    r.style.setProperty('--lcars-purple','#8a6dff');
    r.style.setProperty('--lcars-text','#cfe8ff');
  }
}

// === DASHBOARD SYNC ===
function updateDashboard() {
  // Mirror clock
  var t=document.getElementById('headerTime'); if(t){var dt=document.getElementById('dashTime');if(dt)dt.textContent=t.textContent;}
  var sd=document.getElementById('headerStardate'); if(sd){var ds=document.getElementById('dashStardate');if(ds)ds.textContent=sd.textContent;}
  // Mirror uptime
  var up=document.getElementById('uptimeValue'); if(up){var du=document.getElementById('dashUptime');if(du)du.textContent=up.textContent;}
  // Mirror weather
  var wi=document.getElementById('weatherIcon'); if(wi){var dwi=document.getElementById('dashWeatherIcon');if(dwi)dwi.textContent=wi.textContent;}
  var wt=document.getElementById('weatherTemp'); if(wt){var dwt=document.getElementById('dashWeatherTemp');if(dwt)dwt.textContent=wt.textContent;}
  var wd=document.getElementById('weatherDesc'); if(wd){var dwd=document.getElementById('dashWeatherDesc');if(dwd)dwd.textContent=wd.textContent;}
  // Mirror comms
  var cw=document.getElementById('commsWifi'); if(cw){var dcw=document.getElementById('dashWifi');if(dcw)dcw.textContent=cw.textContent;}
  var cb=document.getElementById('commsBluetooth'); if(cb){var dcb=document.getElementById('dashBluetooth');if(dcb)dcb.textContent=cb.textContent;}
  var cv=document.getElementById('commsVolume'); if(cv){var dcv=document.getElementById('dashVolume');if(dcv)dcv.textContent=cv.textContent;}
  var cbr=document.getElementById('commsBrightness'); if(cbr){var dcbr=document.getElementById('dashBrightness');if(dcbr)dcbr.textContent=cbr.textContent;}
  // Mirror shields
  ['Fwd','Aft','Port','Stbd'].forEach(function(s){
    var el=document.getElementById('shield'+s); var bar=document.getElementById('shield'+s+'Bar');
    var del2=document.getElementById('dashShield'+s); var dbar=document.getElementById('dashShield'+s+'Bar');
    if(el&&del2)del2.textContent=el.textContent;
    if(bar&&dbar)dbar.style.width=bar.style.width;
  });
  // Task summary
  var active=0, overdue=0, now2=new Date().toISOString().slice(0,10);
  tasks.forEach(function(t2){if(!t2.done){active++;if(t2.due&&t2.due<now2)overdue++;}});
  var ts=document.getElementById('dashTaskSummary');
  if(ts) ts.textContent=active+' active'+(overdue>0?' ¬∑ '+overdue+' overdue':'');
  // Latest log
  var ll=document.getElementById('dashLatestLog');
  if(ll) ll.textContent=captainsLog.length>0?'SD '+captainsLog[0].stardate+': '+captainsLog[0].text.substring(0,60)+'...':'';
}

// === SHIELDS ===
function updateShields(){['Fwd','Aft','Port','Stbd'].forEach(function(s){var val=92+Math.random()*8;var el=document.getElementById('shield'+s);var bar=document.getElementById('shield'+s+'Bar');if(el)el.textContent=val.toFixed(0)+'%';if(bar)bar.style.width=val+'%';});}

// === WEATHER (Real via Open-Meteo) ===
function fetchWeather() {
  if (weatherLat === null || weatherLon === null) {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        weatherLat = pos.coords.latitude;
        weatherLon = pos.coords.longitude;
        doFetchWeather();
      }, function() {
        weatherLat = 37.7749; weatherLon = -122.4194; weatherCityName = 'San Francisco';
        var info = document.getElementById('currentLocationInfo');
        if (info) info.textContent = 'Current: San Francisco (default)';
        var label = document.getElementById('weatherCityLabel');
        if (label) label.textContent = 'San Francisco';
        doFetchWeather();
      });
    } else {
      weatherLat = 37.7749; weatherLon = -122.4194; weatherCityName = 'San Francisco';
      doFetchWeather();
    }
    return;
  }
  doFetchWeather();
}

function doFetchWeather() {
  var url = 'https://api.open-meteo.com/v1/forecast?latitude='+weatherLat+'&longitude='+weatherLon+'&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,surface_pressure&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto';
  fetch(url).then(function(r){return r.json();}).then(function(data) {
    if (data && data.current) {
      var c = data.current;
      document.getElementById('weatherTemp').textContent = Math.round(c.temperature_2m) + '¬∞F';
      document.getElementById('weatherHumidity').textContent = c.relative_humidity_2m + '%';
      document.getElementById('weatherWind').textContent = Math.round(c.wind_speed_10m) + ' MPH';
      document.getElementById('weatherPressure').textContent = (c.surface_pressure * 0.02953).toFixed(2) + ' inHg';
      var wc = c.weather_code;
      var desc = 'CLEAR', icon = '‚òÄÔ∏è';
      if (wc >= 1 && wc <= 3) { desc = 'PARTLY CLOUDY'; icon = '‚õÖ'; }
      else if (wc >= 45 && wc <= 48) { desc = 'FOGGY'; icon = 'üå´Ô∏è'; }
      else if (wc >= 51 && wc <= 57) { desc = 'DRIZZLE'; icon = 'üå¶Ô∏è'; }
      else if (wc >= 61 && wc <= 67) { desc = 'RAIN'; icon = 'üåßÔ∏è'; }
      else if (wc >= 71 && wc <= 77) { desc = 'SNOW'; icon = 'üå®Ô∏è'; }
      else if (wc >= 80 && wc <= 82) { desc = 'SHOWERS'; icon = 'üåßÔ∏è'; }
      else if (wc >= 95) { desc = 'THUNDERSTORM'; icon = '‚õàÔ∏è'; }
      document.getElementById('weatherDesc').textContent = desc;
      document.getElementById('weatherIcon').textContent = icon;
    }
  }).catch(function(e){ console.warn('Weather error:',e); });
}

// === CITY SEARCH (Open-Meteo Geocoding) ===
function searchCity() {
  var input = document.getElementById('citySearchInput');
  var query = input.value.trim();
  if (!query) return;
  playClick();
  var resultsDiv = document.getElementById('cityResults');
  resultsDiv.innerHTML = '<div style="color:var(--lcars-teal);font-size:13px;padding:8px;">Searching...</div>';
  fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(query) + '&count=5&language=en&format=json')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      resultsDiv.innerHTML = '';
      if (!data.results || data.results.length === 0) {
        resultsDiv.innerHTML = '<div style="color:var(--lcars-red);font-size:13px;padding:8px;">No cities found. Try a different name.</div>';
        return;
      }
      data.results.forEach(function(city) {
        var div = document.createElement('div');
        div.className = 'city-result';
        var region = city.admin1 ? ', ' + city.admin1 : '';
        var country = city.country ? ', ' + city.country : '';
        div.textContent = city.name + region + country;
        div.onclick = function() {
          playBeep();
          weatherLat = city.latitude;
          weatherLon = city.longitude;
          weatherCityName = city.name;
          var label = document.getElementById('weatherCityLabel');
          if (label) label.textContent = city.name;
          var info = document.getElementById('currentLocationInfo');
          if (info) info.textContent = 'Current: ' + city.name + region + country;
          resultsDiv.innerHTML = '<div style="color:var(--lcars-teal);font-size:13px;padding:8px;">Location set to ' + city.name + '. Fetching weather...</div>';
          fetchWeather();
        };
        resultsDiv.appendChild(div);
      });
    })
    .catch(function(e){
      resultsDiv.innerHTML = '<div style="color:var(--lcars-red);font-size:13px;padding:8px;">Search failed. Check connection.</div>';
    });
}

// === COMMS STATUS (Real via Tauri) ===
function updateComms() {
  if (isTauri) {
    tauriInvoke('get_comms_status').then(function(c) {
      document.getElementById('commsWifi').textContent = c.wifi || 'Not Connected';
      if (c.bluetooth_enabled) {
        var btText = c.bluetooth_devices && c.bluetooth_devices.length > 0 ? c.bluetooth_devices.join(', ') : 'On (no devices)';
        document.getElementById('commsBluetooth').textContent = btText;
      } else {
        document.getElementById('commsBluetooth').textContent = 'Disabled';
      }
      document.getElementById('commsVolume').textContent = (c.volume_percent >= 0 ? c.volume_percent + '%' : '‚Äî');
      document.getElementById('commsBrightness').textContent = (c.brightness_percent >= 0 ? c.brightness_percent + '%' : '‚Äî');
    }).catch(function(e){ console.warn('Comms error:',e); });
  }
}

// === APP LAUNCHER ===
function launchApp(name) {
  playBeep();
  if (isTauri) {
    tauriInvoke('launch_app', { name: name }).catch(function(e){ console.warn('launch error:',e); });
  }
}

// === MAIN LOOP ===
function startSystems() {
  initBgStarfield(); initStarfield3D(); initStarMap(); initOpsStarMap(); initFilesBrowser(); loadTasks(); loadLog();
  setInterval(updateSystems, 2000);
  setInterval(updateClock, 1000);
  setInterval(updateShields, 3000);
  setTimeout(function() { updateComms(); setInterval(updateComms, 30000); }, 10000);
  fetchWeather();
  setInterval(fetchWeather, 300000);
  setInterval(updateDashboard, 2000);
  updateSystems(); updateClock(); updateShields();
  setTimeout(updateDashboard, 3000);
  function drawOpsStarMap(){
    var c=document.getElementById('opsStarMap');
    if(!c||!document.getElementById('panel-ops').classList.contains('active'))return;
    var dpr=window.devicePixelRatio||1;
    var ow=c.offsetWidth,oh=c.offsetHeight;
    if(ow<1||oh<1)return;
    if(c.width!==ow*dpr||c.height!==oh*dpr){c.width=ow*dpr;c.height=oh*dpr;}
    var ctx=c.getContext('2d');
    var w=ow,h=oh;
    ctx.save();ctx.scale(dpr,dpr);
    ctx.fillStyle='rgba(0,5,15,1)';ctx.fillRect(0,0,w,h);
    var cx=w/2,cy=h/2;
    // grid
    ctx.strokeStyle='rgba(102,136,204,0.05)';ctx.lineWidth=0.5;
    var gs=50*starMapZoom;if(gs>10){var ox=((cx+starMapPanX)%gs+gs)%gs,oy=((cy+starMapPanY)%gs+gs)%gs;for(var gx=ox;gx<w;gx+=gs){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,h);ctx.stroke();}for(var gy=oy;gy<h;gy+=gs){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(w,gy);ctx.stroke();}}
    // distance rings
    var solX=cx+starMapPanX,solY=cy+starMapPanY;
    ctx.strokeStyle='rgba(204,102,204,0.1)';ctx.setLineDash([3,6]);
    [5,10,15,20].forEach(function(ly){var r=ly*3*starMapZoom;if(r>3&&r<Math.max(w,h)*2){ctx.beginPath();ctx.arc(solX,solY,r,0,Math.PI*2);ctx.stroke();}});
    ctx.setLineDash([]);
    // relay lines
    ctx.strokeStyle='rgba(0,204,204,0.06)';ctx.lineWidth=0.6;
    for(var i=0;i<starMapData.length;i++){if(starMapData[i].dist>25)continue;for(var j=i+1;j<starMapData.length;j++){if(starMapData[j].dist>25)continue;var dx2=starMapData[i].x-starMapData[j].x,dy2=starMapData[i].y-starMapData[j].y;if(Math.sqrt(dx2*dx2+dy2*dy2)<8){ctx.beginPath();ctx.moveTo(cx+starMapData[i].x*3*starMapZoom+starMapPanX,cy+starMapData[i].y*3*starMapZoom+starMapPanY);ctx.lineTo(cx+starMapData[j].x*3*starMapZoom+starMapPanX,cy+starMapData[j].y*3*starMapZoom+starMapPanY);ctx.stroke();}}}
    // stars
    starMapData.forEach(function(s,idx){var sx=cx+s.x*3*starMapZoom+starMapPanX,sy=cy+s.y*3*starMapZoom+starMapPanY;if(sx<-20||sx>w+20||sy<-20||sy>h+20)return;var size=Math.max(1.5,(3-s.mag/5)*Math.max(0.5,starMapZoom*0.5));var pulse=0.85+0.15*Math.sin(starMapTime*2+idx*1.7);if(starMapSelected===s.name){ctx.strokeStyle='rgba(204,102,204,0.8)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(sx,sy,size+8,0,Math.PI*2);ctx.stroke();}ctx.globalAlpha=pulse*0.3;ctx.fillStyle=s.color;ctx.beginPath();ctx.arc(sx,sy,size*2.5,0,Math.PI*2);ctx.fill();ctx.globalAlpha=pulse;ctx.beginPath();ctx.arc(sx,sy,size,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;var showLabel=(s.name==='Sol'||s.dist<13||s.mag<1.5);if(showLabel&&starMapZoom>0.4){ctx.fillStyle='rgba(102,204,204,0.65)';ctx.font=(s.name==='Sol'?'bold 11px':'9px')+' sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';ctx.fillText(s.name,sx+size+4,sy);}});
    // Sol crosshair
    ctx.strokeStyle='rgba(255,255,0,0.2)';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(solX-12,solY);ctx.lineTo(solX+12,solY);ctx.stroke();ctx.beginPath();ctx.moveTo(solX,solY-12);ctx.lineTo(solX,solY+12);ctx.stroke();
    ctx.restore();
  }
  function initOpsStarMap(){
    var c=document.getElementById('opsStarMap');if(!c)return;
    c.addEventListener('mousedown',function(e){starMapDragging=true;starMapDragX=e.clientX;starMapDragY=e.clientY;});
    c.addEventListener('mousemove',function(e){if(!starMapDragging)return;starMapPanX+=e.clientX-starMapDragX;starMapPanY+=e.clientY-starMapDragY;starMapDragX=e.clientX;starMapDragY=e.clientY;});
    c.addEventListener('mouseup',function(){starMapDragging=false;});
    c.addEventListener('mouseleave',function(){starMapDragging=false;});
    c.addEventListener('wheel',function(e){e.preventDefault();var old=starMapZoom;starMapZoom=Math.max(0.2,Math.min(5.0,starMapZoom*(e.deltaY>0?0.9:1.1)));var r2=starMapZoom/old;starMapPanX*=r2;starMapPanY*=r2;},{passive:false});
    c.addEventListener('click',function(e){var rect=c.getBoundingClientRect();var mx=e.clientX-rect.left,my=e.clientY-rect.top;var dpr=window.devicePixelRatio||1;var w=c.width/dpr,h=c.height/dpr,cx2=w/2,cy2=h/2;var hit=null,best=20;starMapData.forEach(function(s){var sx=cx2+s.x*3*starMapZoom+starMapPanX;var sy=cy2+s.y*3*starMapZoom+starMapPanY;var dd=Math.sqrt((mx-sx)*(mx-sx)+(my-sy)*(my-sy));if(dd<best){best=dd;hit=s;}});if(hit){starMapSelected=hit.name;showStarInfo(hit);playClick();}else{closeStarInfo();}});
  }
  function animate(){drawBgStarfield();drawSensor();drawAstrometrics();drawStarMap();drawOpsStarMap();requestAnimationFrame(animate);}
  animate();
}

// === KEYBOARD ===
document.addEventListener('keydown',function(e){
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if(e.key==='1')switchPanel('ops');else if(e.key==='2')switchPanel('tactical');else if(e.key==='3')switchPanel('science');else if(e.key==='4')switchPanel('comms');else if(e.key==='5')switchPanel('computer');else if(e.key==='6')switchPanel('files');else if(e.key==='7')switchPanel('notepad');else if(e.key==='8')switchPanel('settings');else if(e.key==='9')switchPanel('starmap');
});
window.addEventListener('resize',function(){var c=document.getElementById('starfield');c.width=window.innerWidth;c.height=window.innerHeight;initBgStarfield();});

// === START ===
try { runBoot(); } catch(e) { console.error('Boot error:',e); document.getElementById('bootScreen').style.display='none'; document.getElementById('mainFrame').style.opacity='1'; startSystems(); }
</script>
</body>
</html>
